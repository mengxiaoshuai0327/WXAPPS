# 注册邀请关系问题修复总结

## 问题描述

用户注册时使用了邀请码（如 `M36456006`），但用户列表中"是否他人邀请"和"邀请人编码"显示不正确（显示为"否"和"-"）。

## 问题分析

通过数据库查询发现：
- 邀请码 `M36456006` 对应的用户存在（ID=88，百度1，渠道销售，channel_user_id=9）
- 但用户"孟三一"（ID=90）的 `inviter_id` 为 NULL，说明注册时没有建立邀请关系

## 已完成的修复

### 1. 修复了"孟三一"的数据

使用脚本 `backend/scripts/fix-meng-sanyi-inviter.js` 修复了用户数据：
- ✅ 设置了 `inviter_id = 88`（百度1）
- ✅ 设置了 `promotion_type = 'channel'`
- ✅ 设置了 `channel_sales_id_for_promotion = 'M36456006'`
- ✅ 创建了邀请记录
- ✅ 检查了渠道推广方案（未找到激活的方案，所以没有发放优惠券）

### 2. 增强了注册日志

在注册代码中添加了更详细的日志：
- 当提供了邀请码但未找到邀请人时，会输出警告日志
- 记录插入用户时的 `inviter_id` 值

## 可能的原因

注册时未建立邀请关系可能的原因：

1. **前端未传递邀请码**：前端注册表单可能没有正确传递 `invite_code` 参数
2. **邀请码处理问题**：邀请码在传递过程中可能被处理或丢失
3. **查询时序问题**：注册时邀请人可能还没有创建（但不太可能，因为邀请人是在之前创建的）
4. **代码执行错误**：查询邀请人时可能出现了错误，导致没有设置 `inviter_id`

## 调试方法

### 查看服务器日志

注册时会输出详细的日志，包括：
```
[注册] 接收到的邀请码: "M36456006" (原始), "M36456006" (处理后)
[注册] 开始匹配邀请码: M36456006
[注册] 执行查询: SELECT ... WHERE member_id = 'M36456006' AND role = 'member'
[注册] 查询结果: 找到 1 条记录
[注册] 通过member_id匹配成功: member_id=M36456006, role=member, id=88, channel_user_id=9
[注册] ✓ 找到邀请人: ID=88, ...
[注册] 设置邀请人变量: inviter_id=88, ...
[注册] 准备插入用户: phone=..., member_id=..., inviter_id=88, ...
[注册] ✓ 用户插入成功: user_id=..., inviter_id=88
```

如果看到 `inviter_id=NULL`，说明没有找到邀请人。

如果看到 `⚠️  警告：提供了邀请码 "M36456006" 但未找到邀请人`，说明查询时没有找到匹配的邀请人。

## 后续建议

1. **监控注册日志**：在用户注册时，检查服务器日志，确认是否输出了警告信息
2. **前端验证**：确认前端注册表单是否正确传递了 `invite_code` 参数
3. **数据库验证**：注册后，可以通过SQL查询验证邀请关系是否正确建立

## 修复脚本

如果发现其他用户也存在同样的问题，可以使用修复脚本：

```bash
cd /Users/mxs/Xiaocx/backend
node scripts/fix-meng-sanyi-inviter.js
```

修改脚本中的 `userId`、`inviteCode` 和 `inviterId` 参数即可。

## 验证修复

修复后，用户列表中应该显示：
- **是否他人邀请**：是
- **邀请人编码**：M36456006

请刷新浏览器页面查看结果。

