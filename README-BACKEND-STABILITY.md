# 后端服务器稳定性解决方案

## 问题描述
后端服务器过一段时间后就无法访问，数据加载不出来。

## 解决方案

### 1. 添加了错误处理机制
- 在 `app.js` 中添加了未捕获异常处理
- 添加了数据库连接错误监听
- 添加了优雅关闭处理

### 2. 启动脚本

#### 稳定启动脚本（推荐）
```bash
./start-backend-stable.sh
```

这个脚本会：
- 自动停止旧进程
- 在后台启动服务器
- 将日志输出到文件
- 显示进程ID和日志位置

#### 检查服务器状态
```bash
./check-backend.sh
```

这个脚本会：
- 检查后端服务器是否响应
- 如果无响应，自动重启服务器

### 3. 日志文件位置

- **服务器日志**: `backend/logs/server.log`
- **错误日志**: `backend/logs/error.log`

### 4. 常用命令

#### 查看实时日志
```bash
# 查看服务器日志
tail -f backend/logs/server.log

# 查看错误日志
tail -f backend/logs/error.log

# 同时查看两个日志
tail -f backend/logs/server.log backend/logs/error.log
```

#### 停止服务器
```bash
# 方法1: 使用进程ID（从启动脚本输出中获取）
kill <进程ID>

# 方法2: 使用进程名称
pkill -f "node.*app.js"
```

#### 重启服务器
```bash
./start-backend-stable.sh
```

### 5. 监控建议

#### 定期检查（手动）
可以设置定时任务，定期运行检查脚本：
```bash
# 添加到 crontab（每5分钟检查一次）
*/5 * * * * /path/to/Xiaocx/check-backend.sh
```

#### 监控日志
定期查看错误日志，发现潜在问题：
```bash
# 查看最近的错误
tail -100 backend/logs/error.log

# 查找特定错误
grep -i "error" backend/logs/error.log | tail -50
```

## 改进说明

### 错误处理改进
1. **未捕获异常处理**: 捕获所有未处理的异常，记录日志但不退出进程
2. **Promise拒绝处理**: 捕获所有未处理的Promise拒绝
3. **数据库连接监控**: 监听数据库连接错误，及时发现连接问题

### 日志记录
- 所有错误都会记录到日志文件
- 包含时间戳和错误堆栈信息
- 便于问题排查和调试

### 稳定性提升
- 服务器不会因为单个错误而崩溃
- 错误会被记录，便于后续修复
- 可以通过日志监控服务器状态

## 下一步优化建议

1. **使用PM2（如果权限允许）**: PM2提供更好的进程管理和自动重启功能
2. **添加健康检查API**: 已经添加了 `/health` 端点
3. **数据库连接池优化**: 确保数据库连接池配置合理
4. **内存监控**: 监控内存使用，防止内存泄漏

