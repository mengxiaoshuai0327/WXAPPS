# 头像上传问题排查和修复

## 已修复的问题

### 1. **前端上传代码优化**
- 移除了手动设置的 `content-type` header（微信会自动设置）
- 改进了错误处理和日志输出
- 添加了更详细的错误信息

### 2. **后端代码优化**
- 添加了详细的日志记录
- 改进了错误处理
- 动态获取 BASE_URL（从请求头或环境变量）
- 确保上传目录存在

### 3. **目录创建**
- 已创建 `backend/uploads/avatars/` 目录

## 测试步骤

1. **重新编译小程序**
   - 在微信开发者工具中重新编译

2. **测试上传**
   - 打开注册页面
   - 点击头像区域
   - 选择图片
   - 查看控制台日志

3. **查看日志**
   - 前端：微信开发者工具控制台
   - 后端：查看 `/tmp/backend.log` 或终端输出

## 常见问题

### 问题1：上传失败 - 网络错误
- 检查后端服务是否运行：`curl http://localhost:3000/health`
- 检查 API 地址是否正确：`miniprogram/app.js` 中的 `apiBaseUrl`
- 确保已勾选"不校验合法域名"

### 问题2：上传失败 - 服务器响应格式错误
- 检查后端日志，查看具体错误信息
- 确认上传目录权限：`chmod -R 755 backend/uploads/`

### 问题3：上传成功但图片不显示
- 检查返回的 `avatar_url` 是否正确
- 确认图片路径可访问：`http://192.168.124.6:3000/uploads/avatars/文件名`

## 调试信息

上传时会输出以下日志：
- 前端：上传URL、响应状态码、响应数据
- 后端：收到请求、文件信息、上传成功/失败

如果仍有问题，请查看这些日志信息。

