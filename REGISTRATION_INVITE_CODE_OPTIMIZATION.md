# 注册邀请码查找逻辑优化

## 问题描述

用户注册时填写了邀请码（如 `M31463846`），但用户列表中"是否他人邀请"和"邀请人编码"显示为空。用户建议在注册时，通过检索【用户列表】中的会员ID/授课ID/渠道方ID来确认邀请码对应的角色和渠道方，然后再登记用户信息和赠予优惠券。

## 问题分析

### 当前问题

1. **邀请码查找不完整**：虽然代码中有查找逻辑，但可能在某些情况下没有正确执行
2. **日志不够详细**：无法准确追踪查找过程
3. **普通会员推广类型未设置**：对于普通会员推广，`promotion_type` 为 `null`，导致无法正确统计和显示

### 测试结果

- 邀请码 `M31463846` 对应的用户存在（孟三九，ID: 101，普通会员）
- 但用户"孟三九"自己的 `inviter_id` 为 NULL，说明他注册时也没有找到邀请人

## 优化方案

### 1. 增强日志记录

添加更详细的日志，记录每一步查找过程：

```javascript
console.log(`[注册] ========== 开始匹配邀请码: ${invite_code} ==========`);
console.log(`[注册] 邀请码类型判断: ${invite_code.startsWith('M') ? '可能是会员ID' : ...}`);
console.log(`[注册] 步骤1: 查找会员ID (member_id='${invite_code}', role='member')`);
```

找到邀请人后，输出详细信息：
- 用户ID
- 会员ID
- 角色
- 是否为渠道销售（channel_user_id）
- 姓名
- 所属渠道方（如果是渠道销售）

### 2. 设置普通会员推广类型

对于普通会员推广，设置 `promotion_type = 'member'`：

```javascript
} else if (inviter_role === 'member' && !inviter_channel_user_id) {
  // 普通会员推广
  promotion_type = 'member';
  console.log(`[普通会员推广] 邀请人member_id=${inviters[0].member_id}是普通会员，非渠道销售，设置promotion_type='member'`);
}
```

### 3. 查找逻辑流程

注册时的邀请码查找流程：

1. **步骤1：查找会员ID**（包括普通会员和渠道销售）
   - 查询：`SELECT ... WHERE member_id = ? AND role = 'member'`
   - 重试机制：最多重试5次，每次延迟100ms
   - 如果找到：
     - 判断是否为渠道销售（`channel_user_id` 不为 NULL）
     - 如果是渠道销售，查询渠道方信息
     - 设置相应的 `promotion_type`

2. **步骤2：查找授课人ID**（如果步骤1未找到）
   - 支持多种格式：`I73084993`、`73084993`、自动添加I前缀
   - 查询：`SELECT ... WHERE instructor_id = ? AND role = 'instructor'`

3. **步骤3：查找渠道方**（如果步骤1和2都未找到）
   - 支持格式：`CH981189`（自动转换为 `channel_981189`）
   - 如果找到渠道方，查找该渠道方的第一个渠道销售作为邀请人

### 4. 优惠券发放逻辑

根据邀请人类型发放优惠券：

- **普通会员推广**：
  - 查找 `coupon_schemes` 表中 `scheme_type='member_invite'` 且 `status='active'` 的方案
  - 给邀请人发放注册奖励（`member_inviter_register_amount`）
  - 给被邀请人发放注册奖励（`member_invitee_amount`）

- **渠道销售推广**：
  - 查找 `channel_promotion_schemes` 表中对应渠道方的方案
  - 给被邀请人发放注册奖励（按照渠道推广方案配置）

- **授课人推广**：
  - 查找 `coupon_schemes` 表中 `scheme_type='instructor_invite'` 的方案
  - 给被邀请人发放注册奖励（按照授课人推广方案配置）

## 修改的文件

- `backend/routes/auth.js`：
  - 增强了邀请码查找的日志记录
  - 为普通会员推广设置了 `promotion_type = 'member'`
  - 优化了查找逻辑的输出信息

## 验证方法

### 1. 测试普通会员邀请

1. 使用一个普通会员的ID（如 `M31463846`）作为邀请码注册
2. 查看服务器日志，确认：
   ```
   [注册] ========== 开始匹配邀请码: M31463846 ==========
   [注册] 邀请码类型判断: 可能是会员ID
   [注册] 步骤1: 查找会员ID (member_id='M31463846', role='member')
   [注册] ✓ 通过member_id匹配成功:
     - 用户ID: 101
     - 会员ID: M31463846
     - 角色: member
     - 渠道销售? channel_user_id: NULL
     - 姓名: 孟三九
   [普通会员推广] 邀请人member_id=M31463846是普通会员，非渠道销售，设置promotion_type='member'
   ```
3. 验证用户列表：
   - **是否他人邀请**：是
   - **邀请人编码**：M31463846
4. 验证优惠券：
   - 邀请人和被邀请人都应该收到优惠券（如果会员推广方案已激活）

### 2. 测试渠道销售邀请

1. 使用一个渠道销售的ID（如 `M39124712`）作为邀请码注册
2. 查看服务器日志，确认找到了渠道销售和渠道方信息
3. 验证用户列表和优惠券发放

### 3. 测试授课人邀请

1. 使用一个授课人的ID（如 `I73084993`）作为邀请码注册
2. 查看服务器日志，确认找到了授课人
3. 验证用户列表和优惠券发放

## 注意事项

1. **会员推广方案必须激活**：如果 `coupon_schemes` 表中没有激活的会员推广方案，将无法发放优惠券
2. **日志记录**：所有查找过程都会记录详细日志，便于排查问题
3. **重试机制**：对于新创建的渠道销售，有重试机制确保能找到

## 后续优化建议

1. **前端验证**：在前端添加邀请码格式验证和提示
2. **实时反馈**：在注册时实时验证邀请码是否有效
3. **错误提示**：如果邀请码无效，给出明确的错误提示

