# 营销方案系统重构说明

## 重构概述

将营销方案系统从全局维度改为**用户维度**，支持为每个授课人或渠道方设置独立的营销方案，并支持时间段管理。

## 主要变更

### 1. 数据库结构变更

**旧结构**（全局维度）：
- `applicable_roles` (JSON) - 适用角色列表
- 所有授课人/渠道方共享同一套方案

**新结构**（用户维度）：
- `user_id` (INT) - 关联到具体用户（授课人或渠道方）
- `start_date` (DATE) - 生效开始日期
- `end_date` (DATE) - 生效结束日期
- `status` (ENUM) - 激活/未激活状态

**新表结构**：
```sql
CREATE TABLE `marketing_campaigns` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `user_id` INT NOT NULL COMMENT '用户ID（授课人或渠道方）',
  `discount_rate` DECIMAL(5,2) NOT NULL COMMENT '首次购买折扣比例（如0.20表示20%折扣，即8折）',
  `name` VARCHAR(200) COMMENT '方案名称（可选，用于描述）',
  `description` TEXT COMMENT '方案描述',
  `start_date` DATE COMMENT '生效开始日期（NULL表示立即生效）',
  `end_date` DATE COMMENT '生效结束日期（NULL表示永久有效）',
  `status` ENUM('active', 'inactive') DEFAULT 'active' COMMENT '状态：激活/未激活',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX `idx_user_id` (`user_id`),
  INDEX `idx_status` (`status`),
  INDEX `idx_date_range` (`start_date`, `end_date`)
);
```

### 2. 业务逻辑变更

#### 2.1 营销方案规则

1. **用户维度**：每个授课人或渠道方可以有多个营销方案
2. **时间段管理**：每个方案可以有生效开始日期和结束日期
3. **激活限制**：同一用户在同一时间只能有一个激活的营销方案
4. **个性化折扣**：不同用户可以设置不同的折扣比例

#### 2.2 查询逻辑

在注册时，系统会：
1. 根据邀请人的 `user_id` 查询其营销方案
2. 筛选条件：
   - `status = 'active'`（已激活）
   - `start_date IS NULL OR start_date <= 今天`（已生效）
   - `end_date IS NULL OR end_date >= 今天`（未过期）
3. 如果有多个符合条件的方案，选择最新创建的

### 3. API变更

#### 3.1 创建营销方案

**POST** `/api/admin/marketing/create`

**请求参数**：
```json
{
  "user_id": 123,              // 必填：用户ID（授课人或渠道方）
  "discount_rate": 0.20,       // 必填：折扣比例（0.20 = 20%折扣 = 8折）
  "name": "渠道方A的营销方案",  // 可选：方案名称
  "description": "描述",       // 可选：方案描述
  "start_date": "2024-01-01",  // 可选：生效开始日期（NULL表示立即生效）
  "end_date": "2024-12-31",    // 可选：生效结束日期（NULL表示永久有效）
  "status": "active"           // 可选：状态（active/inactive），默认active
}
```

**验证规则**：
- 用户必须是授课人或渠道方
- 折扣比例必须在0-1之间
- 如果状态是激活，该用户在同一时间段不能有其他激活的方案
- 开始日期不能晚于结束日期

#### 3.2 获取营销方案列表

**GET** `/api/admin/marketing/list`

**查询参数**：
- `user_id` - 用户ID筛选
- `role` - 角色筛选（instructor/channel）
- `status` - 状态筛选（active/inactive）

**返回数据**：
包含用户信息（昵称、姓名、ID等）的营销方案列表

#### 3.3 更新营销方案

**PUT** `/api/admin/marketing/:id`

**请求参数**：与创建接口相同（所有字段可选）

**验证规则**：
- 如果更新状态为激活，检查该用户是否在同一时间段已有其他激活的方案

### 4. 管理员页面变更

#### 4.1 营销方案管理页面

**新增功能**：
1. 用户选择器：可选择授课人或渠道方
2. 时间段设置：支持设置生效开始日期和结束日期
3. 激活/未激活状态切换
4. 筛选功能：按角色、状态、用户筛选

**页面展示**：
- 显示用户信息（昵称、ID、角色）
- 显示折扣比例和实际折扣（如：20%折扣 = 8折）
- 显示生效时间范围
- 显示激活状态

#### 4.2 使用流程

1. **创建营销方案**：
   - 点击"创建营销方案"
   - 选择用户（授课人或渠道方）
   - 设置折扣比例（如0.20表示8折，0.30表示7折）
   - 设置生效时间段（可选）
   - 选择激活状态
   - 保存

2. **编辑营销方案**：
   - 点击"编辑"按钮
   - 修改折扣比例、时间段、状态等
   - 保存

3. **激活/停用方案**：
   - 点击"激活"/"停用"按钮
   - 系统会自动检查是否与其他方案冲突

## 使用示例

### 示例1：为渠道方A设置8折优惠

```json
{
  "user_id": 100,
  "discount_rate": 0.20,
  "name": "渠道方A的营销方案",
  "start_date": "2024-01-01",
  "end_date": "2024-12-31",
  "status": "active"
}
```

结果：渠道方A邀请的用户首次购买享受20%折扣（即8折）

### 示例2：为渠道方B设置7折优惠

```json
{
  "user_id": 101,
  "discount_rate": 0.30,
  "name": "渠道方B的营销方案",
  "start_date": "2024-01-01",
  "end_date": null,
  "status": "active"
}
```

结果：渠道方B邀请的用户首次购买享受30%折扣（即7折），永久有效

### 示例3：同一用户不同时间段的方案

- 方案1：2024-01-01 至 2024-06-30，8折（0.20）
- 方案2：2024-07-01 至 2024-12-31，7折（0.30）

两个方案可以同时存在，系统会根据当前日期自动选择生效的方案。

## 注意事项

1. **折扣比例计算**：
   - 0.20 = 20%折扣 = 8折（用户支付原价的80%）
   - 0.30 = 30%折扣 = 7折（用户支付原价的70%）
   - 公式：实际支付 = 原价 × (1 - discount_rate)

2. **时间段冲突检查**：
   - 系统会检查同一用户在同一时间段是否有其他激活的方案
   - 如果时间段不重叠，可以同时激活多个方案

3. **日期处理**：
   - `start_date` 为 NULL：表示立即生效
   - `end_date` 为 NULL：表示永久有效
   - 日期比较使用当前日期（不包括时间部分）

4. **数据迁移**：
   - 旧表数据已备份到 `marketing_campaigns_old`
   - 如有需要，可以手动迁移数据到新表结构

## 测试建议

1. **创建测试**：
   - 为不同的授课人/渠道方创建不同的折扣方案
   - 测试时间段设置
   - 测试激活/停用功能

2. **冲突检测测试**：
   - 尝试为同一用户在同一时间段创建两个激活的方案，应提示冲突

3. **注册流程测试**：
   - 使用不同用户的邀请码注册
   - 验证是否正确应用了对应的折扣方案

4. **时间段测试**：
   - 创建有时间范围的方案
   - 验证在有效期内和有效期外的行为

