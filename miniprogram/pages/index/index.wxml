<!--pages/index/index.wxml-->
<wxs module="utils">
  function formatAmount(amount) {
    var num = parseFloat(amount || 0);
    if (isNaN(num)) return '0.00';
    if (num % 1 === 0) {
      return num.toString();
    }
    return num.toFixed(2);
  }
  module.exports.formatAmount = formatAmount;
</wxs>
<view class="container">
  <!-- é¡¶éƒ¨è£…é¥° -->
  <view class="top-decoration"></view>
  
  <!-- æ¸¸å®¢é¦–é¡µ -->
  <block wx:if="{{!userInfo || userRole == 'visitor'}}">
    <view class="content-wrapper">
      <!-- Banner -->
      <view class="banner-container" wx:if="{{banners.length > 0}}">
          <swiper 
            class="banner-swiper" 
            indicator-dots="{{banners.length > 1}}" 
            autoplay="true" 
            interval="3000" 
            duration="500" 
            circular="{{banners.length > 1}}"
          >
            <swiper-item wx:for="{{banners}}" wx:key="id">
              <image class="banner-image" src="{{item.image_url}}" mode="aspectFill" binderror="onBannerError"></image>
            </swiper-item>
          </swiper>
      </view>

    <!-- è¯¾ç¨‹ä½“ç³»ä»‹ç» -->
    <view class="section">
      <view class="section-title">è¯¾ç¨‹ä½“ç³»ä»‹ç»</view>
      <view class="theme-grid">
        <view class="theme-item {{item.status === 'inactive' ? 'theme-item-inactive' : ''}}" wx:for="{{modules}}" wx:key="id" bindtap="viewModule" data-id="{{item.id}}">
          <view class="theme-icon {{item.status === 'inactive' ? 'theme-icon-inactive' : ''}}" style="background-color: {{item.status === 'inactive' ? '#e0e0e0' : item.color}};">
            <text class="icon-text">{{item.icon}}</text>
          </view>
          <view class="theme-title {{item.status === 'inactive' ? 'theme-title-inactive' : ''}}">{{item.name}}</view>
        </view>
      </view>
    </view>

    <!-- çƒ­é—¨æ•™ç»ƒ -->
    <view class="section" wx:if="{{popularInstructors.length > 0}}">
      <view class="section-title">çƒ­é—¨æ•™ç»ƒ</view>
      <scroll-view class="instructors-scroll" scroll-x="true">
        <view class="instructor-list">
          <view class="instructor-card" wx:for="{{popularInstructors}}" wx:key="id" bindtap="viewInstructorProfile" data-id="{{item.id}}">
            <view class="instructor-avatar-wrapper">
              <image class="instructor-avatar" src="{{item.avatar_url || '/images/å¤´åƒ.png'}}" mode="aspectFill"></image>
            </view>
            <view class="instructor-info">
              <view class="instructor-name">{{item.display_name}}</view>
              <view class="instructor-stats">
                <text class="stat-item">è¯¾ç¨‹ {{item.course_count || 0}}</text>
              </view>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>

      <!-- åº•éƒ¨æç¤º -->
      <view class="footer-tip">
        <text>ç™»å½•æˆä¸ºä¼šå‘˜å³å¯é¢„è®¢è¯¾ç¨‹ã€è¯„ä»·è¯¾ç¨‹ã€é‚€è¯·å¥½å‹ç­‰</text>
        <button class="register-btn" bindtap="showRegisterModal">æ³¨å†Œä¼šå‘˜</button>
      </view>
    </view>
  </block>

  <!-- ä¼šå‘˜é¦–é¡µ -->
  <block wx:if="{{userInfo && userRole == 'member'}}">
    <view class="content-wrapper">
      <!-- é¡¶éƒ¨æ¬¢è¿åŒºåŸŸ -->
      <view class="member-header-card">
        <view class="user-info">
          <view class="user-avatar">
            <image wx:if="{{userInfo.avatar_url}}" src="{{userInfo.avatar_url}}" mode="aspectFill"></image>
            <image wx:else src="/images/å¤´åƒ.png" mode="aspectFill"></image>
          </view>
          <view class="user-text">
            <view class="welcome-text">æ¬¢è¿å›æ¥</view>
            <view class="user-name">{{userInfo.nickname || userInfo.real_name || 'ä¼šå‘˜'}}</view>
            <view class="subtitle-text">å¼€å¯æ‚¨çš„ä¸“å±å­¦ä¹ ä¹‹æ—…</view>
          </view>
        </view>
        <view class="listen-btn-wrapper">
          <view class="listen-btn {{isListenBtnPressed ? 'pressed' : ''}}" 
                bindtouchstart="onListenBtnTouchStart"
                bindtouchend="onListenBtnTouchEnd"
                bindtap="goToCourseIntention">
            <view class="listen-icon-wrapper">
              <text class="listen-icon">ğŸ‘‚</text>
            </view>
            <text class="listen-text">å€¾å¬</text>
          </view>
        </view>
      </view>

      <!-- è¯¾åˆ¸ä½™é¢å¡ç‰‡ -->
      <view class="ticket-card" bindtap="goToTickets">
        <view class="ticket-left">
          <view class="ticket-icon-wrapper">
            <text class="ticket-icon">ğŸ«</text>
          </view>
          <view class="ticket-info">
            <view class="ticket-count">{{ticketCount || 0}}</view>
            <view class="ticket-label">è¯¾åˆ¸ä½™é¢</view>
          </view>
        </view>
        <view class="ticket-link">æŸ¥çœ‹è¯¦æƒ… ></view>
      </view>

    <!-- å·²é¢„è®¢è¯¾ç¨‹ -->
    <view class="section-card">
      <view class="section-header">
        <view class="section-title">å·²é¢„è®¢è¯¾ç¨‹</view>
        <text class="section-link" bindtap="goToMyBookings">æŸ¥çœ‹å…¨éƒ¨ ></text>
      </view>
      <block wx:if="{{bookedCourses.length > 0}}">
        <scroll-view class="booked-courses-scroll" scroll-x="true">
          <view class="booked-course-card" wx:for="{{bookedCourses}}" wx:key="booking_id" bindtap="viewCourseDetail" data-id="{{item.course_id}}">
            <view class="course-card-content">
              <view class="course-card-title">{{item.title}}</view>
              <view class="course-card-info">
                <text class="info-icon">ğŸ‘¤</text>
                <text class="info-value">{{item.instructor_name}}</text>
              </view>
              <view class="course-card-info">
                <text class="info-icon">ğŸ•</text>
                <text class="info-value">{{item.date_time_text}}</text>
              </view>
              <view class="course-card-info">
                <text class="info-icon blue">ğŸ‘¥</text>
                <text class="info-value blue">{{item.current_students}}/{{item.max_students}} äºº</text>
              </view>
            </view>
          </view>
        </scroll-view>
      </block>
      <block wx:else>
        <view class="empty-state">
          <text class="empty-text">ä½ è¿˜æ²¡æœ‰é¢„è®¢è¯¾ç¨‹~</text>
          <text class="empty-hint">å»çœ‹çœ‹è¯¾ç¨‹è¡¨å§</text>
          <button class="btn-primary" bindtap="goToSchedule">æŸ¥çœ‹è¯¾ç¨‹è¡¨</button>
        </view>
      </block>
    </view>

    <!-- å¾…ç­¾åˆ°æ‰“å¡ -->
    <view class="section-card" wx:if="{{pendingCheckins.length > 0}}">
      <view class="evaluation-card" bindtap="goToCheckin">
        <view class="evaluation-icon-wrapper">
          <text class="evaluation-icon">âœ“</text>
        </view>
        <view class="evaluation-content">
          <view class="evaluation-title">å¾…ç­¾åˆ°æ‰“å¡</view>
          <view class="evaluation-tags">
            <text class="evaluation-tag" wx:for="{{pendingCheckins}}" wx:key="booking_id">{{item.title}}</text>
          </view>
        </view>
        <view class="evaluation-link">å»ç­¾åˆ° ></view>
      </view>
    </view>

    <!-- å¾…è¯„ä»·è¯¾ç¨‹ -->
    <view class="section-card" wx:if="{{pendingEvaluations.length > 0}}">
      <view class="evaluation-card" bindtap="goToEvaluation">
        <view class="evaluation-icon-wrapper">
          <text class="evaluation-icon">â­</text>
        </view>
        <view class="evaluation-content">
          <view class="evaluation-title">å¾…è¯„ä»·è¯¾ç¨‹</view>
          <view class="evaluation-tags">
            <text class="evaluation-tag" wx:for="{{pendingEvaluations}}" wx:key="id">{{item.title}}</text>
          </view>
        </view>
        <view class="evaluation-link">å»è¯„ä»· ></view>
      </view>
    </view>

    <!-- ä¼˜æƒ åˆ¸å¥–åŠ± -->
    <view class="section-card">
      <view class="coupon-reward-card" bindtap="goToDiscountCoupons">
        <view class="coupon-reward-icon-wrapper">
          <text class="coupon-reward-icon">ğŸ«</text>
        </view>
        <view class="coupon-reward-content">
          <view class="coupon-reward-title">ä¼˜æƒ åˆ¸å¥–åŠ±</view>
          <view class="coupon-reward-amount">Â¥{{utils.formatAmount(couponStats.unused_amount || 0)}}</view>
        </view>
        <view class="coupon-reward-link">æŸ¥çœ‹è¯¦æƒ… ></view>
      </view>
    </view>

    <!-- é‚€è¯·ä¸“åŒº -->
    <view class="section-card">
      <view class="invite-zone-card" bindtap="goToInvitation">
        <view class="invite-zone-icon-wrapper">
          <text class="invite-zone-icon">ğŸ</text>
        </view>
        <view class="invite-zone-content">
          <view class="invite-zone-title">é‚€è¯·ä¸“åŒº</view>
          <view class="invite-zone-subtitle">é‚€è¯·å¥½å‹æ³¨å†Œï¼Œè·å¾—ä¼˜æƒ åˆ¸å¥–åŠ±</view>
        </view>
        <view class="invite-zone-link">æŸ¥çœ‹è¯¦æƒ… ></view>
      </view>
    </view>

    <!-- ç³»ç»Ÿæ¶ˆæ¯ -->
    <view class="section-card">
      <view class="section-header">
        <view class="section-title">ç³»ç»Ÿæ¶ˆæ¯</view>
        <text class="section-link" bindtap="goToMessages">æŸ¥çœ‹å…¨éƒ¨ ></text>
      </view>
      <view class="message-list">
        <view class="message-item" wx:for="{{systemMessages}}" wx:key="id" bindtap="viewMessage" data-id="{{item.id}}">
          <view class="message-icon-wrapper">
            <text class="message-icon">ğŸ””</text>
          </view>
          <view class="message-content">
            <view class="message-title">{{item.title}}</view>
            <view class="message-time">{{item.created_at}}</view>
          </view>
        </view>
        <view wx:if="{{systemMessages.length === 0}}" class="empty-message">
          <text class="empty-message-text">æš‚æ— ç³»ç»Ÿæ¶ˆæ¯</text>
        </view>
      </view>
    </view>

      <!-- é€€å‡ºç™»å½•æŒ‰é’® -->
      <view class="logout-section">
        <button class="logout-btn" bindtap="handleLogout">
          <text class="logout-text">é€€å‡ºç™»å½•</text>
        </button>
      </view>
    </view>
  </block>

  <!-- æ•™ç»ƒé¦–é¡µï¼ˆä¸ä¼šå‘˜é¦–é¡µä¸€è‡´ï¼‰ -->
  <block wx:if="{{userInfo && userRole == 'instructor'}}">
    <view class="content-wrapper">
      <!-- é¡¶éƒ¨æ¬¢è¿åŒºåŸŸ -->
      <view class="member-header-card">
        <view class="user-info">
          <view class="user-avatar">
            <image wx:if="{{userInfo.avatar_url}}" src="{{userInfo.avatar_url}}" mode="aspectFill"></image>
            <image wx:else src="/images/å¤´åƒ.png" mode="aspectFill"></image>
          </view>
          <view class="user-text">
            <view class="welcome-text">æ¬¢è¿å›æ¥</view>
            <view class="user-name">{{userInfo.nickname || userInfo.real_name || 'æ•™ç»ƒ'}}</view>
            <view class="subtitle-text">å¼€å¯æ‚¨çš„ä¸“å±å­¦ä¹ ä¹‹æ—…</view>
          </view>
        </view>
        <view class="listen-btn-wrapper">
          <view class="listen-btn {{isListenBtnPressed ? 'pressed' : ''}}" 
                bindtouchstart="onListenBtnTouchStart"
                bindtouchend="onListenBtnTouchEnd"
                bindtap="goToCourseIntention">
            <view class="listen-icon-wrapper">
              <text class="listen-icon">ğŸ‘‚</text>
            </view>
            <text class="listen-text">å€¾å¬</text>
          </view>
        </view>
      </view>

      <!-- è¯¾åˆ¸ä½™é¢å¡ç‰‡ -->
      <view class="ticket-card" bindtap="goToTickets">
        <view class="ticket-left">
          <view class="ticket-icon-wrapper">
            <text class="ticket-icon">ğŸ«</text>
          </view>
          <view class="ticket-info">
            <view class="ticket-count">{{ticketCount || 0}}</view>
            <view class="ticket-label">è¯¾åˆ¸ä½™é¢</view>
          </view>
        </view>
        <view class="ticket-link">æŸ¥çœ‹è¯¦æƒ… ></view>
      </view>

    <!-- å·²é¢„è®¢è¯¾ç¨‹ -->
    <view class="section-card">
      <view class="section-header">
        <view class="section-title">å·²é¢„è®¢è¯¾ç¨‹</view>
        <text class="section-link" bindtap="goToMyBookings">æŸ¥çœ‹å…¨éƒ¨ ></text>
      </view>
      <block wx:if="{{bookedCourses.length > 0}}">
        <scroll-view class="booked-courses-scroll" scroll-x="true">
          <view class="booked-course-card" wx:for="{{bookedCourses}}" wx:key="booking_id" bindtap="viewCourseDetail" data-id="{{item.course_id}}">
            <view class="course-card-content">
              <view class="course-card-title">{{item.title}}</view>
              <view class="course-card-info">
                <text class="info-icon">ğŸ‘¤</text>
                <text class="info-value">{{item.instructor_name}}</text>
              </view>
              <view class="course-card-info">
                <text class="info-icon">ğŸ•</text>
                <text class="info-value">{{item.date_time_text}}</text>
              </view>
              <view class="course-card-info">
                <text class="info-icon blue">ğŸ‘¥</text>
                <text class="info-value blue">{{item.current_students}}/{{item.max_students}} äºº</text>
              </view>
            </view>
          </view>
        </scroll-view>
      </block>
      <block wx:else>
        <view class="empty-state">
          <text class="empty-text">ä½ è¿˜æ²¡æœ‰é¢„è®¢è¯¾ç¨‹~</text>
          <text class="empty-hint">å»çœ‹çœ‹è¯¾ç¨‹è¡¨å§</text>
          <button class="btn-primary" bindtap="goToSchedule">æŸ¥çœ‹è¯¾ç¨‹è¡¨</button>
        </view>
      </block>
    </view>

    <!-- å¾…è¯„ä»·è¯¾ç¨‹ï¼ˆè¿‡æ»¤æ‰è‡ªå·±çš„è¯¾ç¨‹ï¼‰ -->
    <view class="section-card" wx:if="{{pendingEvaluations.length > 0}}">
      <view class="evaluation-card" bindtap="goToEvaluation">
        <view class="evaluation-icon-wrapper">
          <text class="evaluation-icon">â­</text>
        </view>
        <view class="evaluation-content">
          <view class="evaluation-title">å¾…è¯„ä»·è¯¾ç¨‹</view>
          <view class="evaluation-tags">
            <text class="evaluation-tag" wx:for="{{pendingEvaluations}}" wx:key="id">{{item.title}}</text>
          </view>
        </view>
        <view class="evaluation-link">å»è¯„ä»· ></view>
      </view>
    </view>

    <!-- ä¼˜æƒ åˆ¸å¥–åŠ± -->
    <view class="section-card">
      <view class="coupon-reward-card" bindtap="goToDiscountCoupons">
        <view class="coupon-reward-icon-wrapper">
          <text class="coupon-reward-icon">ğŸ«</text>
        </view>
        <view class="coupon-reward-content">
          <view class="coupon-reward-title">ä¼˜æƒ åˆ¸å¥–åŠ±</view>
          <view class="coupon-reward-amount">Â¥{{utils.formatAmount(couponStats.unused_amount || 0)}}</view>
        </view>
        <view class="coupon-reward-link">æŸ¥çœ‹è¯¦æƒ… ></view>
      </view>
    </view>

    <!-- é‚€è¯·ä¸“åŒº -->
    <view class="section-card">
      <view class="invite-zone-card" bindtap="goToInvitation">
        <view class="invite-zone-icon-wrapper">
          <text class="invite-zone-icon">ğŸ</text>
        </view>
        <view class="invite-zone-content">
          <view class="invite-zone-title">é‚€è¯·ä¸“åŒº</view>
          <view class="invite-zone-subtitle">é‚€è¯·å¥½å‹æ³¨å†Œï¼Œè·å¾—ä¼˜æƒ åˆ¸å¥–åŠ±</view>
        </view>
        <view class="invite-zone-link">æŸ¥çœ‹è¯¦æƒ… ></view>
      </view>
    </view>

    <!-- ç³»ç»Ÿæ¶ˆæ¯ -->
    <view class="section-card">
      <view class="section-header">
        <view class="section-title">ç³»ç»Ÿæ¶ˆæ¯</view>
        <text class="section-link" bindtap="goToMessages">æŸ¥çœ‹å…¨éƒ¨ ></text>
      </view>
      <view class="message-list">
        <view class="message-item" wx:for="{{systemMessages}}" wx:key="id" bindtap="viewMessage" data-id="{{item.id}}">
          <view class="message-icon-wrapper">
            <text class="message-icon">ğŸ””</text>
          </view>
          <view class="message-content">
            <view class="message-title">{{item.title}}</view>
            <view class="message-time">{{item.created_at}}</view>
          </view>
        </view>
        <view wx:if="{{systemMessages.length === 0}}" class="empty-message">
          <text class="empty-message-text">æš‚æ— ç³»ç»Ÿæ¶ˆæ¯</text>
        </view>
      </view>
    </view>

      <!-- é€€å‡ºç™»å½•æŒ‰é’® -->
      <view class="logout-section">
        <button class="logout-btn" bindtap="handleLogout">
          <text class="logout-text">é€€å‡ºç™»å½•</text>
        </button>
      </view>
    </view>
  </block>
</view>
