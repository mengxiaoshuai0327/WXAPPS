<!--pages/discount-coupons/discount-coupons.wxml-->
<view class="container">
  <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
  <view class="header">
    <view class="header-title">æˆ‘çš„ä¼˜æƒ åˆ¸</view>
    <view class="policy-link" bindtap="showPolicy">
      <text class="policy-icon">â„¹ï¸</text>
      <text class="policy-text">ä½¿ç”¨è¯´æ˜</text>
    </view>
  </view>

  <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
  <view class="tabs-container">
    <view class="tab-item {{currentTab === 'unused' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="unused">
      <text class="tab-text">æœªä½¿ç”¨</text>
      <view class="tab-badge" wx:if="{{couponStats.unused > 0}}">{{couponStats.unused}}</view>
    </view>
    <view class="tab-item {{currentTab === 'used' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="used">
      <text class="tab-text">å·²ä½¿ç”¨</text>
      <view class="tab-badge" wx:if="{{couponStats.used > 0}}">{{couponStats.used}}</view>
    </view>
    <view class="tab-item {{currentTab === 'expired' ? 'active' : ''}}" 
          bindtap="switchTab" data-tab="expired">
      <text class="tab-text">å·²è¿‡æœŸ</text>
      <view class="tab-badge" wx:if="{{couponStats.expired > 0}}">{{couponStats.expired}}</view>
    </view>
  </view>

  <!-- ä¼˜æƒ åˆ¸åˆ—è¡¨ -->
  <view class="coupons-container">
    <view class="coupon-card" wx:for="{{coupons}}" wx:key="id">
      <!-- å·¦ä¾§é‡‘é¢åŒºåŸŸ -->
      <view class="coupon-amount-section">
        <view class="coupon-amount">Â¥{{item.amount}}</view>
        <view class="coupon-status-badge {{item.status === 'used' ? 'status-used' : item.status === 'expired' ? 'status-expired' : 'status-unused'}}">
          {{item.status === 'used' ? 'å·²ä½¿ç”¨' : item.status === 'expired' ? 'å·²è¿‡æœŸ' : 'æœªä½¿ç”¨'}}
        </view>
      </view>
      
      <!-- å³ä¾§ä¿¡æ¯åŒºåŸŸ -->
      <view class="coupon-info-section">
        <view class="info-row">
          <text class="info-label">è·å¾—æ–¹å¼</text>
          <text class="info-value source-value">{{item.source_text}}</text>
        </view>
        
        <view class="info-row" wx:if="{{item.status === 'unused' && item.expiry_date}}">
          <text class="info-label">æœ‰æ•ˆæœŸè‡³</text>
          <text class="info-value expiry-value">{{item.expiry_date_formatted}}</text>
        </view>
        
        <view class="info-row" wx:if="{{item.status === 'unused' && !item.expiry_date}}">
          <text class="info-label">æœ‰æ•ˆæœŸ</text>
          <text class="info-value expiry-value">æ°¸ä¹…æœ‰æ•ˆ</text>
        </view>
        
        <view class="info-row">
          <text class="info-label">è·å¾—æ—¶é—´</text>
          <text class="info-value">{{item.created_at_formatted}}</text>
        </view>
        
        <view class="info-row" wx:if="{{item.used_at}}">
          <text class="info-label">ä½¿ç”¨æ—¶é—´</text>
          <text class="info-value">{{item.used_at_formatted}}</text>
        </view>
      </view>
      
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{coupons.length === 0 && !loading}}">
      <text class="empty-icon">ğŸ«</text>
      <text class="empty-text">æš‚æ— ä¼˜æƒ åˆ¸</text>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-state" wx:if="{{loading}}">
      <text>åŠ è½½ä¸­...</text>
    </view>
  </view>

  <!-- æµ·æŠ¥Canvasï¼ˆéšè—ï¼‰ -->
  <canvas 
    canvas-id="posterCanvas" 
    id="posterCanvas"
    class="poster-canvas"
    style="width: 750px; height: 1334px;">
  </canvas>

  <!-- æµ·æŠ¥é¢„è§ˆå¼¹çª— -->
  <view class="poster-modal" wx:if="{{showPoster}}" bindtap="closePoster">
    <view class="poster-modal-content" catchtap="stopPropagation">
      <view class="poster-header">
        <text class="poster-title">é‚€è¯·æµ·æŠ¥</text>
        <text class="poster-close" bindtap="closePoster">Ã—</text>
      </view>
      <view class="poster-image-wrapper">
        <image class="poster-image" src="{{posterImage}}" mode="aspectFit"></image>
      </view>
      <view class="poster-actions">
        <button class="poster-action-btn save-btn" bindtap="savePoster">ä¿å­˜åˆ°ç›¸å†Œ</button>
        <button class="poster-action-btn close-btn" bindtap="closePoster">å…³é—­</button>
      </view>
    </view>
  </view>
</view>
