<!--pages/schedule/schedule.wxml-->
<view class="container">
  <!-- é¡¶éƒ¨è£…é¥° -->
  <view class="top-decoration"></view>
  
  <view class="content-wrapper">
    <!-- ç­›é€‰æ å¡ç‰‡ -->
    <view class="filter-card">
      <!-- ç¬¬ä¸€è¡Œï¼šæ¨¡å—å’Œä¸»é¢˜ -->
      <view class="filter-row">
        <!-- æ¨¡å—ç­›é€‰ -->
        <view class="filter-item-wrapper">
          <view class="filter-label">è¯¾ç¨‹æ¨¡å—</view>
          <picker 
            mode="selector" 
            range="{{moduleOptions}}" 
            range-key="name"
            value="{{moduleIndex}}" 
            bindchange="onModuleChange">
            <view class="picker-view {{selectedModule !== null ? 'active' : ''}}">
              <text class="picker-text">{{selectedModuleName || 'å…¨éƒ¨'}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>

        <!-- ä¸»é¢˜ç­›é€‰ -->
        <view class="filter-item-wrapper">
          <view class="filter-label">è¯¾ç¨‹ä¸»é¢˜</view>
          <picker 
            mode="selector" 
            range="{{themeOptions}}" 
            range-key="name"
            value="{{themeIndex}}" 
            bindchange="onThemeChange"
            disabled="{{themeOptions.length === 0}}">
            <view class="picker-view {{selectedTheme !== null ? 'active' : ''}} {{themeOptions.length === 0 ? 'disabled' : ''}}">
              <text class="picker-text">{{selectedThemeName || 'å…¨éƒ¨'}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
      </view>

      <!-- ç¬¬äºŒè¡Œï¼šå¼€è¯¾æ—¶é—´ -->
      <view class="filter-row filter-row-second">
        <view class="filter-item-wrapper filter-item-full">
          <view class="filter-label">å¼€è¯¾æ—¶é—´</view>
          <picker 
            mode="multiSelector" 
            range="{{dateRange}}" 
            value="{{dateIndex}}" 
            bindchange="onDateChange">
            <view class="picker-view {{selectedYearMonth ? 'active' : ''}}">
              <text class="picker-text">{{selectedYearMonth || 'é€‰æ‹©å¹´æœˆ'}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
      </view>
    </view>

    <!-- è¯¾ç¨‹åˆ—è¡¨ -->
    <view class="schedule-list">
      <view class="schedule-item" wx:for="{{schedules}}" wx:key="id">
        <!-- é¡¶éƒ¨ï¼šä¸»é¢˜æ ‡ç­¾ -->
        <view class="theme-header">
          <view class="theme-dot"></view>
          <text class="theme-name">{{item.theme_name}}</text>
        </view>

        <!-- ä¸»ä½“å†…å®¹ï¼šå·¦ä¾§å›¾ç‰‡ + å³ä¾§ä¿¡æ¯ -->
        <view class="card-body">
          <!-- å·¦ä¾§å›¾ç‰‡ï¼šæˆè¯¾æ•™å¸ˆå¤´åƒ -->
          <view class="course-image">
            <image 
              class="instructor-avatar" 
              src="{{item.instructor_avatar || '/images/å¤´åƒ.png'}}" 
              mode="aspectFill"
              lazy-load="true"
            ></image>
          </view>

          <!-- å³ä¾§å†…å®¹ -->
          <view class="course-content">
            <!-- è¯¾ç¨‹æ ‡é¢˜ -->
            <view class="course-title">{{item.title}}</view>

            <!-- è®²å¸ˆä¿¡æ¯ -->
            <view class="info-row">
              <text class="info-icon">ğŸ‘¤</text>
              <text class="info-text">{{item.instructor_name}}</text>
            </view>

            <!-- å¼€è¯¾æ—¶é—´ï¼ˆé¢„æ’è¯¾ä¸æ˜¾ç¤ºï¼‰ -->
            <view class="info-row" wx:if="{{item.status !== 'draft' && item.date_time_text && item.date_time_text !== 'é¢„æ’è¯¾'}}">
              <text class="info-icon">ğŸ•</text>
              <text class="info-text">å¼€è¯¾æ—¶é—´: {{item.date_time_text}}</text>
            </view>

            <!-- æŠ¥åäººæ•°ï¼ˆé¢„æ’è¯¾ä¸æ˜¾ç¤ºï¼‰ -->
            <view class="info-row" wx:if="{{item.status !== 'draft'}}">
              <text class="info-icon blue">ğŸ‘¥</text>
              <text class="info-text blue">{{item.current_students}}/{{item.max_students}}äºº</text>
            </view>

            <!-- å¾…å¼€è¯¾çŠ¶æ€æ˜¾ç¤º -->
            <view class="info-row" wx:if="{{item.status === 'draft'}}">
              <text class="info-icon">ğŸ“</text>
              <text class="info-text">å¾…å¼€è¯¾</text>
            </view>
          </view>
        </view>

        <!-- åº•éƒ¨ï¼šä½ç½®å’Œæ“ä½œ -->
        <view class="card-footer">
          <!-- åœ°å€ä¿¡æ¯å•ç‹¬ä¸€è¡Œ -->
          <view class="location-row">
            <!-- æ¸¸å®¢æ˜¾ç¤º"çº¿ä¸‹" -->
            <view class="location-info" wx:if="{{userRole === 'visitor'}}">
              <text class="location-icon">ğŸ“</text>
              <text class="location-text">çº¿ä¸‹</text>
            </view>
            <!-- ä¼šå‘˜/æ•™ç»ƒ/æ¸ é“é”€å”®æ˜¾ç¤ºçœŸå®åœ°å€ -->
            <view class="location-info" wx:elif="{{userRole === 'member' || userRole === 'instructor' || isChannelSales}}">
              <text class="location-icon">ğŸ“</text>
              <text class="location-text">{{item.location || 'çº¿ä¸‹Â·æ•™å®¤'}}</text>
            </view>
            <!-- å…¶ä»–æƒ…å†µï¼ˆå…œåº•ï¼‰ -->
            <view class="location-info" wx:else>
              <text class="location-icon">ğŸ“</text>
              <text class="location-text">çº¿ä¸‹</text>
            </view>
          </view>
          <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
          <view class="footer-actions">
            <!-- å·¦ä¾§ï¼šçŠ¶æ€æ ‡ç­¾æˆ–æ“ä½œæŒ‰é’® -->
            <view class="footer-left">
              <!-- å¾…å¼€è¯¾çŠ¶æ€ä¼˜å…ˆæ˜¾ç¤º -->
              <text wx:if="{{item.status === 'draft'}}" class="status-badge draft">å¾…å¼€è¯¾</text>
              <!-- å¾…å¼€è¯¾çŠ¶æ€æ˜¾ç¤ºå…³æ³¨æŒ‰é’® -->
              <button wx:if="{{item.status === 'draft' && userRole !== 'visitor'}}" 
                      class="btn-follow {{item.is_interested ? 'btn-followed' : ''}}" 
                      catchtap="toggleInterest" 
                      data-id="{{item.id}}"
                      data-interested="{{item.is_interested}}">
                <text class="follow-icon">{{item.is_interested ? 'âœ“' : '+'}}</text>
                <text>{{item.is_interested ? 'å·²å…³æ³¨' : 'å…³æ³¨'}}</text>
              </button>
              <!-- éå¾…å¼€è¯¾çŠ¶æ€çš„å…¶ä»–çŠ¶æ€æ˜¾ç¤º -->
              <text wx:elif="{{item.status !== 'draft' && item.is_in_progress}}" class="status-badge in-progress">ä¸Šè¯¾ä¸­</text>
              <text wx:elif="{{item.status !== 'draft' && item.is_past}}" class="status-badge">å·²ç»“æŸ</text>
              <text wx:elif="{{item.status !== 'draft' && item.current_students >= item.max_students}}" class="status-badge">å·²æ»¡å‘˜</text>
              
              <!-- å·²é¢„è®¢ä¸”å¯å–æ¶ˆï¼ˆé¢„æ’è¯¾ã€ä¸Šè¯¾ä¸­ã€å·²ç»“æŸä¸æ˜¾ç¤ºï¼‰ -->
              <button wx:if="{{item.status !== 'draft' && item.has_booking && item.can_cancel && !item.is_past && !item.is_in_progress}}" 
                      class="btn-action btn-cancel" 
                      catchtap="cancelBooking" 
                      data-id="{{item.booking_id}}">
                å–æ¶ˆé¢„è®¢
              </button>
              
              <!-- å·²é¢„è®¢ä½†ä¸å¯å–æ¶ˆï¼ˆä¸‰å¤©å†…ï¼Œé¢„æ’è¯¾ã€ä¸Šè¯¾ä¸­ã€å·²ç»“æŸä¸æ˜¾ç¤ºï¼‰ -->
              <button wx:if="{{item.status !== 'draft' && item.has_booking && !item.can_cancel && !item.is_past && !item.is_in_progress}}" 
                      class="btn-action btn-cancel-disabled" 
                      catchtap="showCancelTip"
                      data-id="{{item.booking_id}}">
                å–æ¶ˆé¢„è®¢
              </button>
              
              <!-- å†å²è¯¾ç¨‹ä¸”å·²é¢„è®¢ï¼ˆé¢„æ’è¯¾ä¸æ˜¾ç¤ºï¼‰ -->
              <text wx:if="{{item.status !== 'draft' && item.has_booking && item.is_past}}" class="btn-action btn-disabled-text">
                å·²é¢„è®¢
              </text>
              
              <!-- å¯é¢„è®¢ï¼ˆåŒ…æ‹¬å–æ¶ˆé¢„è®¢åçš„çŠ¶æ€ï¼Œä½†æ’é™¤æ•™ç»ƒè‡ªå·±çš„è¯¾ç¨‹ã€é¢„æ’è¯¾ã€ä¸Šè¯¾ä¸­ã€å·²ç»“æŸï¼‰ -->
              <button wx:if="{{item.status !== 'draft' && item.can_book && !item.is_past && !item.is_in_progress && !item.has_booking && !item.is_own_course}}" 
                      class="btn-action btn-book" 
                      bindtap="bookCourse" 
                      data-id="{{item.id}}">
                é¢„è®¢
              </button>
              
              <!-- æ•™ç»ƒè‡ªå·±çš„è¯¾ç¨‹æ˜¾ç¤ºæç¤ºï¼ˆé¢„æ’è¯¾ã€ä¸Šè¯¾ä¸­ã€å·²ç»“æŸä¸æ˜¾ç¤ºï¼‰ -->
              <text wx:if="{{item.status !== 'draft' && item.is_own_course && !item.is_past && !item.is_in_progress}}" class="btn-action btn-disabled-text">
                è‡ªå·±çš„è¯¾ç¨‹
              </text>
            </view>
            
            <!-- å³ä¾§ï¼šè¯¦æƒ…æŒ‰é’® -->
            <text class="btn-action detail-btn" bindtap="viewCourseDetail" data-id="{{item.course_id}}">è¯¦æƒ… ></text>
          </view>
        </view>
      </view>

      <view wx:if="{{schedules.length === 0 && !loading}}" class="empty-state">
        <text>æš‚æ— è¯¾ç¨‹</text>
      </view>
    </view>

    <view wx:if="{{loading}}" class="loading">åŠ è½½ä¸­...</view>
  </view>
</view>
