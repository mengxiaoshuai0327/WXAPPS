<!--pages/ticket-purchase/ticket-purchase.wxml-->
<view class="container">
  <view class="header">
    <view class="header-icon">
      <text class="icon-text">ğŸ’³</text>
    </view>
    <view class="header-title">è´­ä¹°è¯¾åˆ¸</view>
    <view class="header-subtitle">é€‰æ‹©ä¼˜æƒ åˆ¸,äº«å—ä¸“å±ä¼˜æƒ </view>
  </view>

  <view class="content-card">
    <!-- è´­ä¹°æ•°é‡ -->
    <view class="section">
      <view class="section-label">
        <text>è´­ä¹°æ•°é‡</text>
      </view>
      <view class="quantity-control">
        <view class="quantity-input-wrapper">
          <view class="quantity-btn {{quantity <= 1 ? 'disabled' : ''}}" bindtap="decreaseQuantity">-</view>
          <input class="quantity-input" type="digit" value="{{quantity}}" bindinput="onQuantityInput" />
          <view class="quantity-btn {{quantity >= 99 ? 'disabled' : ''}}" bindtap="increaseQuantity">+</view>
        </view>
        <text class="quantity-tip">æ¯æ¬¡æœ€å¤šè´­ä¹°99å¼ </text>
      </view>
    </view>

    <!-- ä¼˜æƒ åˆ¸ -->
    <view class="section">
      <view class="section-label">
        <text>ä¼˜æƒ åˆ¸</text>
        <text class="label-tip">ï¼ˆæ¯å¼ è¯¾åˆ¸æœ€å¤šä½¿ç”¨1å¼ ï¼Œæœ€å¤šå¯é€‰{{quantity}}å¼ ï¼‰</text>
      </view>
      <view class="coupon-selector" bindtap="showCouponPicker">
        <text class="coupon-text" wx:if="{{selectedCoupons.length > 0}}">
          å·²é€‰æ‹©{{selectedCoupons.length}}å¼ ä¼˜æƒ åˆ¸
          <text wx:if="{{selectedCoupons.length === 1}}">ï¼ˆ{{selectedCoupons[0].amount}}å…ƒï¼‰</text>
          <text wx:else>ï¼ˆ{{selectedCoupons[0].amount}}å…ƒç­‰{{selectedCoupons.length}}å¼ ï¼‰</text>
        </text>
        <text class="coupon-text placeholder" wx:else>ä¸ä½¿ç”¨ä¼˜æƒ åˆ¸</text>
        <view class="btn-clear" wx:if="{{selectedCoupons.length > 0}}" bindtap="clearCoupon" catchtap="clearCoupon">Ã—</view>
        <text class="arrow">></text>
      </view>
    </view>

    <!-- è®¢å•è¯¦æƒ… -->
    <view class="section order-section">
      <view class="order-item">
        <text class="order-label">å•ä»·</text>
        <text class="order-value price">Â¥ {{unitPriceText}}</text>
      </view>
      <view class="order-item">
        <text class="order-label">æ•°é‡</text>
        <text class="order-value">x {{quantity}}</text>
      </view>
      <view class="order-item">
        <text class="order-label">æŠ˜æ‰£</text>
        <text class="order-value discount">- Â¥ {{discountAmountText}}</text>
      </view>
      <view class="order-divider"></view>
      <view class="order-item total">
        <text class="order-label">å®ä»˜é‡‘é¢</text>
        <text class="order-value total-price">Â¥ {{totalAmountText}}</text>
      </view>
    </view>

    <!-- æç¤ºä¿¡æ¯ -->
    <view class="info-section">
      <text class="info-icon">â„¹</text>
      <text class="info-text">è¯¾åˆ¸è´­ä¹°åå¯åœ¨ã€Œæˆ‘çš„â€”è¯¾åˆ¸ã€ä¸­æŸ¥çœ‹åŠä½¿ç”¨</text>
    </view>
  </view>

  <!-- æ”¯ä»˜æŒ‰é’® -->
  <view class="pay-section">
    <button class="btn-pay" bindtap="handlePay" disabled="{{loading}}">
      <text class="pay-icon">ğŸ’³</text>
      <text>ç«‹å³æ”¯ä»˜</text>
    </button>
  </view>

  <!-- ä¼˜æƒ åˆ¸é€‰æ‹©å™¨ -->
  <view class="coupon-picker-mask" wx:if="{{showCouponPicker}}" bindtap="hideCouponPicker">
    <view class="coupon-picker" catchtap="stopPropagation">
      <view class="picker-header">
        <text class="picker-title">é€‰æ‹©ä¼˜æƒ åˆ¸ï¼ˆæœ€å¤š{{quantity}}å¼ ï¼‰</text>
        <text class="picker-close" bindtap="hideCouponPicker">Ã—</text>
      </view>
      <view class="picker-content">
        <view class="coupon-option" bindtap="selectNoCoupon">
          <text>ä¸ä½¿ç”¨ä¼˜æƒ åˆ¸</text>
          <text class="option-check" wx:if="{{selectedCoupons.length === 0}}">âœ“</text>
        </view>
        <view class="coupon-option" wx:for="{{availableCoupons}}" wx:key="id" bindtap="selectCoupon" data-id="{{item.id}}">
          <view class="coupon-info">
            <text class="coupon-amount">{{item.amount}}å…ƒ</text>
            <text class="coupon-expiry" wx:if="{{item.start_date_formatted || item.expiry_date_formatted}}">
              <text wx:if="{{item.start_date_formatted && item.expiry_date_formatted}}">
                {{item.start_date_formatted}} è‡³ {{item.expiry_date_formatted}}
              </text>
              <text wx:elif="{{item.start_date_formatted}}">
                {{item.start_date_formatted}} èµ·
              </text>
              <text wx:elif="{{item.expiry_date_formatted}}">
                è‡³ {{item.expiry_date_formatted}}
              </text>
            </text>
            <text class="coupon-expiry" wx:else>æ°¸ä¹…æœ‰æ•ˆ</text>
          </view>
          <text class="option-check" wx:if="{{item.isSelected}}">âœ“</text>
        </view>
        <view class="picker-empty" wx:if="{{availableCoupons.length === 0}}">
          <text>æš‚æ— å¯ç”¨ä¼˜æƒ åˆ¸</text>
          <text class="debug-info" style="font-size: 24rpx; color: #999; margin-top: 20rpx; display: block;">è°ƒè¯•ï¼šå·²åŠ è½½{{availableCoupons.length}}æ¡</text>
        </view>
      </view>
    </view>
  </view>

  <view wx:if="{{loading}}" class="loading">å¤„ç†ä¸­...</view>
</view>

