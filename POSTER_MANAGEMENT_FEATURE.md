# 邀请海报管理功能说明

## 功能概述

实现了完整的邀请海报管理功能，包括：
1. ✅ 修复了二维码不显示的问题
2. ✅ 管理员后台可以上传和管理海报模板
3. ✅ 小程序生成海报时自动使用管理员上传的模板，并在指定位置叠加二维码

## 数据库迁移

首先需要运行数据库迁移来创建 `posters` 表：

```bash
cd backend
mysql -u root -p xiaocx_db < database/migrations/create_posters_table.sql
```

或者使用已有的数据库初始化脚本。

## 功能说明

### 1. 后端API

#### 海报管理API

- **GET /api/posters/list** - 获取激活的海报模板列表（小程序使用）
- **GET /api/posters/admin/list** - 获取所有海报模板（管理员使用）
- **POST /api/posters/admin/upload** - 上传海报模板
- **PUT /api/posters/admin/:id** - 更新海报信息
- **DELETE /api/posters/admin/:id** - 删除海报模板

#### 二维码生成API

- **GET /api/invitations/qrcode/:inviteCode** - 生成邀请二维码

### 2. 管理员后台

#### 访问路径
- 菜单：侧边栏 → "邀请海报管理"
- 路由：`/posters/list`

#### 功能
1. **上传海报模板**
   - 上传海报图片（支持 jpg/png/gif，最大10MB）
   - 设置海报名称
   - 配置二维码位置（X、Y坐标）
   - 配置二维码大小
   - 设置排序顺序
   - 设置激活状态

2. **编辑海报模板**
   - 修改海报名称
   - 调整二维码位置和大小
   - 修改排序和状态

3. **激活/停用海报**
   - 只有激活的海报模板会在小程序中使用

4. **删除海报**
   - 删除海报模板（会同时删除服务器上的图片文件）

#### 海报模板配置说明

- **二维码X坐标**：二维码左上角距离海报左边的像素距离
- **二维码Y坐标**：二维码左上角距离海报顶部的像素距离
- **二维码大小**：建议200-400像素，确保扫描清晰度

**建议**：
- 在海报设计时预留二维码位置（建议至少300x300像素）
- 二维码位置避免过于靠近边缘
- 确保二维码区域背景简洁，提高扫描成功率

### 3. 小程序功能

#### 生成海报流程

1. 用户进入"我的邀请"页面
2. 点击"生成海报"按钮
3. 系统自动：
   - 从后端获取激活的海报模板列表
   - 随机选择一个海报模板
   - 下载海报模板图片
   - 生成用户专属的邀请二维码
   - 在指定位置将二维码叠加到海报模板上
   - 生成最终海报图片

4. 用户可以：
   - 预览生成的海报
   - 保存海报到相册
   - 分享海报给朋友

#### 二维码显示

- 二维码自动加载显示
- 二维码内容：`pages/register/register?invite_code=XXX`
- 扫码后自动跳转到注册页面并填写邀请码

## 使用流程

### 管理员操作：

1. 登录管理员后台
2. 进入"邀请海报管理"页面
3. 点击"上传海报模板"
4. 上传海报图片并配置二维码位置
5. 设置状态为"激活"
6. 保存后，小程序用户就可以使用这个模板生成海报了

### 小程序用户操作：

1. 进入"我的" → "我的邀请"
2. 查看邀请码和二维码
3. 点击"生成海报"按钮
4. 系统自动使用管理员上传的模板生成海报
5. 保存海报到相册或直接分享

## 技术实现

### 后端
- 使用 `multer` 处理文件上传
- 海报图片存储在 `backend/uploads/posters/` 目录
- 使用 `qrcode` 库生成二维码

### 前端（小程序）
- 使用 Canvas API 绘制海报
- 先绘制海报模板作为背景
- 在指定位置叠加二维码
- 如果没有模板，使用默认样式

## 注意事项

1. **海报模板尺寸**：建议使用标准尺寸（如750x1334像素），确保在不同设备上显示正常

2. **二维码位置**：管理员需要根据海报设计准确配置二维码位置，确保二维码不会遮挡重要内容

3. **二维码大小**：太小可能影响扫描，太大可能影响美观，建议200-400像素

4. **海报模板数量**：建议至少准备2-3个不同的海报模板，系统会随机选择

5. **文件大小**：海报图片建议不超过5MB，确保上传和加载速度

## 问题排查

### 二维码不显示
- ✅ 已修复：二维码URL路径已修正为 `/api/invitations/qrcode/:inviteCode`
- 确认后端服务正常运行
- 确认网络连接正常

### 海报生成失败
- 检查是否有激活的海报模板
- 检查海报图片是否能正常访问
- 查看小程序控制台错误信息

### 二维码位置不对
- 在管理员后台重新配置二维码位置
- 确保坐标值正确（X、Y为像素值）

## 后续优化建议

1. **海报模板预览**：在配置二维码位置时，提供可视化预览功能
2. **多尺寸支持**：支持不同尺寸的海报模板（横版、竖版等）
3. **二维码样式**：支持自定义二维码颜色和样式
4. **批量上传**：支持批量上传海报模板
5. **使用统计**：统计不同海报模板的使用情况

