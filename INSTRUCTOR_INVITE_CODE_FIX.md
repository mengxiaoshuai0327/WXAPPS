# 授课人邀请码匹配优化

## 问题描述

用户注册时输入邀请码 `I73084993`，但没有获得优惠券。

## 问题分析

当前代码逻辑：
1. 如果邀请码是纯数字（如 `73084993`），会添加 I 前缀后匹配（`I73084993`）
2. 但如果用户输入的是 `I73084993`（已有 I 前缀），直接用原邀请码匹配
3. **问题**：如果数据库中不存在 `instructor_id = 'I73084993'` 但存在 `instructor_id = '73084993'`（只有数字），就找不到

## 修复方案

优化匹配逻辑，支持三种情况：
1. **第一次尝试**：使用原邀请码匹配（如果用户输入 `I73084993`，就用 `I73084993` 匹配）
2. **第二次尝试**：如果没找到且邀请码以 I 开头，去掉 I 前缀后匹配（`I73084993` → `73084993`）
3. **第三次尝试**：如果还是没找到且是纯数字，添加 I 前缀匹配（`73084993` → `I73084993`）

## 代码位置

`backend/routes/auth.js` 第394-435行

## 匹配逻辑示例

### 情况1：用户输入 `I73084993`
1. 尝试匹配 `instructor_id = 'I73084993'`
2. 如果没找到，尝试匹配 `instructor_id = '73084993'`（去掉 I 前缀）

### 情况2：用户输入 `73084993`
1. 尝试匹配 `instructor_id = '73084993'`
2. 如果没找到，尝试匹配 `instructor_id = 'I73084993'`（添加 I 前缀）

### 情况3：用户输入 `I73084993` 且数据库中存在 `I73084993`
1. 第一次尝试就找到，直接返回

## 验证方法

1. **检查数据库中是否存在该授课人**：
   ```sql
   SELECT id, instructor_id, nickname, real_name 
   FROM users 
   WHERE instructor_id IN ('I73084993', '73084993') 
     AND role = 'instructor';
   ```

2. **查看服务器日志**：
   注册时会输出详细日志，包括：
   - `[注册] 开始尝试匹配instructor_id，邀请码=I73084993`
   - `[注册] 第一次尝试：使用原邀请码匹配instructor_id='I73084993'`
   - `[注册] 第二次尝试：去掉I前缀后匹配instructor_id='73084993'`
   - `[注册] ✓ 找到授课人` 或 `[注册] ✗ 未找到授课人`

3. **检查优惠券是否发放**：
   ```sql
   SELECT dc.*, u.real_name
   FROM discount_coupons dc
   LEFT JOIN users u ON dc.user_id = u.id
   WHERE u.phone = '18900001111'
   ORDER BY dc.created_at DESC;
   ```

## 其他可能的问题

如果仍然没有获得优惠券，可能的原因：

1. **数据库中没有该授课人**：
   - 检查 `users` 表中是否存在 `instructor_id` 为 `I73084993` 或 `73084993` 的授课人记录

2. **授课人推广方案未激活**：
   - 检查 `coupon_schemes` 表中是否存在 `scheme_type='instructor_invite'` 且 `status='active'` 的记录
   - 检查 `instructor_invitee_amount > 0`

3. **优惠券发放逻辑错误**：
   - 查看服务器日志中的 `[授课人优惠券发放]` 相关日志
   - 检查是否有错误信息

## 下一步

1. 重启服务器，使代码更改生效
2. 让用户重新注册，查看服务器日志输出
3. 根据日志判断是匹配失败还是优惠券发放失败

