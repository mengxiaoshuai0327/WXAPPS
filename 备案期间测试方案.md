# 域名备案期间测试方案

## 📋 概述

在域名备案期间（通常需要15-20个工作日），虽然无法提交代码审核或正式发布，但可以通过以下两种方法进行开发和测试：

1. **本地开发调试**（推荐首选）- 最简单快速
2. **使用云服务**（如腾讯云开发 AnyService）- 更接近真实环境

---

## 🎯 方案对比

| 特性 | 本地开发调试 | 使用云服务（AnyService） |
|------|------------|----------------------|
| **核心原理** | 在开发者工具中临时禁用域名验证规则 | 通过云服务提供的已备案域名/IP进行通信 |
| **是否需要备案域名** | ❌ 不需要 | ❌ 不需要（使用云服务提供的域名） |
| **优点** | • 简单快速<br>• 零成本<br>• 适合纯前端调试和API联调 | • 更接近真实线上环境<br>• 可测试需要真实域名白名单的功能（如文件上传、云函数） |
| **限制** | • 仅在开发者工具和开发版有效<br>• 生成的预览版和正式版小程序无效 | • 需要将后端服务部署或连接到对应云平台（如腾讯云） |
| **适用阶段** | 早期功能开发、API联调 | 中后期测试、需要真机预览体验版或测试完整业务流程 |

---

## ✅ 方案一：本地开发调试（推荐首选）

### 原理说明

在微信开发者工具中勾选"不校验合法域名"选项，临时禁用域名验证规则，使请求不受域名白名单限制，可以正常访问未备案的服务器地址进行调试。

### 操作步骤

#### 1. 配置微信开发者工具

1. **打开微信开发者工具**
   - 打开你的小程序项目

2. **进入设置页面**
   - 点击右上角的 **"详情"** 按钮
   - 或使用快捷键：`Cmd + ,` (Mac) / `Ctrl + ,` (Windows)

3. **本地设置**
   - 在左侧菜单中找到 **"本地设置"** 选项卡
   - 勾选以下选项：
     - ✅ **不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书**
     - ✅ **不校验安全域名**

4. **保存并重新编译**
   - 关闭设置窗口
   - 点击工具栏的 **"编译"** 按钮
   - 或使用快捷键：`Cmd + R` (Mac) / `Ctrl + R` (Windows)

#### 2. 配置项目设置（已配置）

项目中的 `project.config.json` 和 `project.private.config.json` 已经设置了：
```json
{
  "setting": {
    "urlCheck": false
  }
}
```

#### 3. 配置 API 地址

在 `miniprogram/app.js` 中配置 API 地址：

```javascript
globalData: {
  // 本地开发环境API地址
  // 如果使用微信开发者工具模拟器，使用 localhost
  // 如果使用手机预览，使用局域网IP
  apiBaseUrl: 'http://localhost:3000/api', // 开发者工具模拟器
  // apiBaseUrl: 'http://192.168.x.x:3000/api', // 手机预览时使用
}
```

**获取局域网 IP 地址：**
- Mac: 在终端运行 `ifconfig | grep "inet " | grep -v 127.0.0.1`
- Windows: 在命令提示符运行 `ipconfig`，查找 IPv4 地址

#### 4. 启动后端服务

确保后端服务正在运行：
```bash
cd backend
npm start
# 或
node app.js
```

验证服务是否正常：
```bash
curl http://localhost:3000/health
```

### 验证设置

设置完成后，小程序应该能够正常访问后端 API：
- ✅ 课程表页面可以加载课程数据
- ✅ 主题筛选功能正常
- ✅ 课程详情可以查看
- ✅ 用户登录功能正常
- ✅ 其他 API 请求正常

### 注意事项

⚠️ **重要限制**：
- 此方法**仅在微信开发者工具中有效**
- 生成的**预览版和正式版小程序无效**
- 无法分享给其他用户在微信 App 中测试
- 仅适用于开发阶段的本地调试

---

## ☁️ 方案二：使用云服务进行测试

### 原理说明

通过腾讯云开发（CloudBase）的 AnyService 等服务，将你的后端服务通过云服务提供的已备案域名或 IP 地址进行访问。小程序通过这个"网关"进行通信，从而绕过域名白名单验证。

### 操作步骤（以腾讯云开发 AnyService 为例）

#### 1. 开通腾讯云开发服务

1. 访问 [腾讯云开发控制台](https://console.cloud.tencent.com/tcb)
2. 创建或选择环境
3. 开通 AnyService 服务

#### 2. 配置 AnyService

1. 在云开发控制台中，进入 **"云函数"** 或 **"AnyService"** 页面
2. 创建新的服务配置
3. 填写你的服务器 IP 地址和端口（如：`http://你的服务器IP:3000`）
4. 获取云开发提供的域名（格式类似：`https://your-env-id.ap-shanghai.app.tcloudbase.com`）

#### 3. 修改小程序 API 地址

在 `miniprogram/app.js` 中修改 API 地址：

```javascript
globalData: {
  // 使用云开发提供的域名
  apiBaseUrl: 'https://your-env-id.ap-shanghai.app.tcloudbase.com/api',
}
```

#### 4. 配置后端服务（如果需要）

如果后端需要接收来自云开发的请求，可能需要：
- 配置 CORS 允许云开发域名
- 配置反向代理规则
- 确保后端服务可以通过公网访问

### 其他云服务选项

除了腾讯云开发，还可以考虑：
- **内网穿透工具**（如 ngrok、frp）：将本地服务暴露到公网
- **其他云服务商**：阿里云、华为云等提供的类似服务

### 注意事项

⚠️ **重要提示**：
- 需要将后端服务部署到可公网访问的服务器，或使用内网穿透
- 可能需要一定的云服务费用
- 配置相对复杂，适合需要更真实测试环境的场景

---

## 🔍 常见问题排查

### 问题1：仍然无法访问 API

**排查步骤**：
1. ✅ 检查后端服务是否运行：`curl http://localhost:3000/health`
2. ✅ 检查 API 地址是否正确：查看 `miniprogram/app.js` 中的 `apiBaseUrl`
3. ✅ 确认已勾选"不校验合法域名"选项
4. ✅ 查看微信开发者工具控制台的错误信息
5. ✅ 检查后端日志是否有请求记录

### 问题2：网络请求失败

**排查步骤**：
1. ✅ 确保手机和电脑在同一 WiFi 网络（如果使用手机预览）
2. ✅ 如果使用手机预览，需要将 IP 地址改为电脑的局域网 IP
3. ✅ 检查防火墙设置，确保端口 3000 未被阻止
4. ✅ 尝试在浏览器中直接访问 API 地址验证服务是否正常

### 问题3：手机预览无法连接

**解决方案**：
1. 获取电脑的局域网 IP 地址
2. 修改 `miniprogram/app.js` 中的 `apiBaseUrl` 为局域网 IP
3. 确保手机和电脑在同一 WiFi 网络
4. 在微信开发者工具中点击"预览"，用手机微信扫描二维码

### 问题4：体验版无法使用

**说明**：
- 本地开发调试方案**不支持**体验版
- 体验版必须使用已备案的 HTTPS 域名
- 需要等待备案完成后才能上传体验版给其他用户测试

---

## 📝 当前项目配置状态

### ✅ 已完成的配置

1. **项目配置文件**：
   - `project.config.json` 中已设置 `urlCheck: false`
   - `project.private.config.json` 中已设置 `urlCheck: false`

2. **API 地址配置**：
   - `miniprogram/app.js` 中已配置 `apiBaseUrl: 'http://localhost:3000/api'`

3. **后端服务**：
   - 后端服务运行在 `http://localhost:3000`
   - 已配置 CORS 允许跨域请求

### 🔧 需要手动完成的步骤

1. **在微信开发者工具中勾选"不校验合法域名"**（必须手动操作）
2. **根据使用场景调整 API 地址**：
   - 开发者工具模拟器：使用 `http://localhost:3000/api`
   - 手机预览：使用 `http://你的局域网IP:3000/api`

---

## 🎯 推荐使用流程

### 阶段一：开发阶段（备案期间）

1. ✅ 使用**方案一：本地开发调试**
2. ✅ 在微信开发者工具中勾选"不校验合法域名"
3. ✅ 使用 `localhost` 或局域网 IP 进行开发
4. ✅ 完成功能开发和 API 联调
5. ❌ **不要**上传体验版（因为无法正常使用）

### 阶段二：测试阶段（备案完成后）

1. ✅ 配置已备案的 HTTPS 域名
2. ✅ 配置 SSL 证书
3. ✅ 在微信公众平台配置服务器域名
4. ✅ 修改小程序 API 地址为 HTTPS 域名
5. ✅ 上传体验版
6. ✅ 分享给其他用户测试

### 阶段三：正式发布（测试通过后）

1. ✅ 提交审核
2. ✅ 审核通过后发布正式版
3. ✅ 所有用户都可以使用

---

## 📚 相关文档

- [开发工具设置说明.md](./miniprogram/开发工具设置说明.md) - 详细的开发者工具设置步骤
- [微信小程序测试限制说明.md](./微信小程序测试限制说明.md) - 关于测试限制的详细说明

---

## ⚠️ 重要提醒

1. **本地开发调试方案仅适用于开发阶段**，无法用于体验版或正式版
2. **体验版和正式版必须使用已备案的 HTTPS 域名**
3. **备案完成后才能让其他用户正常使用小程序**，这是微信小程序平台的硬性要求
4. 在备案期间，建议专注于功能开发和本地测试，等待备案完成后再进行体验版测试

---

**最后更新**：根据网络上的备案期间测试方案整理

