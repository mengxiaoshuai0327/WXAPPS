# 备案前小程序测试部署方案

## 📋 方案概述

由于您的腾讯云备案正在审核中（预计15-20个工作日），在正式域名备案完成前，可以使用以下方案进行小程序测试部署：

### ✅ 方案优势
- **无需等待备案**：可以立即开始测试
- **成本低**：测试阶段可以使用较便宜的配置
- **功能完整**：可以测试所有小程序功能
- **便于切换**：备案完成后可平滑切换到正式环境

---

## 🎯 推荐方案：使用腾讯云服务器 + IP地址/测试域名

### 方案一：使用服务器IP地址（推荐用于测试）

#### 1. 准备工作

**① 购买腾讯云服务器（如果还没有）**
- 推荐配置：1核2G（测试够用，约50-100元/月）
- 操作系统：CentOS 7+ 或 Ubuntu 18.04+
- 开放端口：3000（后端API端口）

**② 配置安全组**
在腾讯云控制台 → 云服务器 → 安全组：
- 开放端口：3000（TCP协议）
- 开放端口：22（SSH，用于远程连接）
- 开放端口：8080（如果需要访问管理员前端）

#### 2. 服务器部署步骤

**① 连接服务器**
```bash
ssh root@你的服务器IP
```

**② 安装Node.js环境**
```bash
# 使用nvm安装（推荐）
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18
node -v  # 验证安装
```

**③ 安装MySQL数据库**
```bash
# CentOS
yum install mysql-server -y
systemctl start mysqld
systemctl enable mysqld

# Ubuntu
apt-get update
apt-get install mysql-server -y
systemctl start mysql
systemctl enable mysql
```

**④ 上传项目代码**
```bash
# 方法1：使用git（推荐）
cd /var/www
git clone 你的代码仓库地址 xiaocx
cd xiaocx

# 方法2：使用scp从本地上传
# 在本地执行：
# scp -r /Users/mxs/Xiaocx root@服务器IP:/var/www/xiaocx
```

**⑤ 配置后端环境**
```bash
cd /var/www/xiaocx/backend

# 安装依赖
npm install

# 创建.env文件
cat > .env << EOF
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=你的数据库密码
DB_NAME=xiaocx_db
DB_PORT=3306
PORT=3000
HOST=0.0.0.0
NODE_ENV=production
EOF

# 导入数据库
mysql -u root -p xiaocx_db < database/schema.sql
# 如果有迁移文件，也执行：
mysql -u root -p xiaocx_db < database/migrations/create_protocols_table.sql
```

**⑥ 使用PM2启动后端服务**
```bash
# 安装PM2
npm install -g pm2

# 启动后端服务
cd /var/www/xiaocx/backend
pm2 start app.js --name xiaocx-backend
pm2 save
pm2 startup  # 设置开机自启

# 查看状态
pm2 status
pm2 logs xiaocx-backend
```

#### 3. 小程序配置

**① 修改API地址**
编辑 `miniprogram/app.js`：
```javascript
globalData: {
  // 测试环境：使用服务器IP地址
  apiBaseUrl: 'http://你的服务器IP:3000/api',
  // 例如：apiBaseUrl: 'http://123.456.789.012:3000/api',
  // 注意：生产环境需要使用HTTPS域名
}
```

**② 微信开发者工具配置**
1. 打开微信开发者工具
2. 点击右上角"详情"
3. 在"本地设置"中勾选：
   - ✅ **不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书**
   - ✅ **不校验安全域名**

**③ 上传代码并提交审核**
- 在微信开发者工具中点击"上传"
- 填写版本号和项目备注
- 登录[微信公众平台](https://mp.weixin.qq.com/)提交审核

---

### 方案二：使用已备案的域名（让其他用户测试的必需方案）

**重要**：如果想让其他微信用户在微信App中测试体验版小程序，必须使用已备案的HTTPS域名。

#### 可选方案：

**方案A：使用已备案的其他域名（如果有）**

如果您已有其他已备案的域名，可以：
1. 将域名解析指向腾讯云服务器
2. 配置SSL证书（可使用Let's Encrypt免费证书）
3. 配置Nginx反向代理
4. 在微信公众平台配置该域名为合法域名
5. 小程序使用该域名的HTTPS地址

**方案B：使用临时测试域名（如果腾讯云提供）**

如果腾讯云在备案期间提供了临时测试域名（通常需要额外申请），可以：

**① 配置SSL证书**
```bash
# 使用Let's Encrypt免费证书
yum install certbot -y
certbot certonly --standalone -d 你的测试域名.com

# 证书位置：
# /etc/letsencrypt/live/你的测试域名.com/fullchain.pem
# /etc/letsencrypt/live/你的测试域名.com/privkey.pem
```

**② 配置Nginx反向代理（使用HTTPS）**
```bash
# 安装Nginx
yum install nginx -y

# 配置Nginx
cat > /etc/nginx/conf.d/xiaocx.conf << EOF
server {
    listen 443 ssl;
    server_name 你的测试域名.com;

    ssl_certificate /etc/letsencrypt/live/你的测试域名.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/你的测试域名.com/privkey.pem;

    location /api {
        proxy_pass http://localhost:3000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
    }
}

server {
    listen 80;
    server_name 你的测试域名.com;
    return 301 https://\$server_name\$request_uri;
}
EOF

# 启动Nginx
systemctl start nginx
systemctl enable nginx
```

**③ 小程序配置**
```javascript
globalData: {
  apiBaseUrl: 'https://你的测试域名.com/api',
}
```

---

## 🔄 备案完成后的正式环境切换

备案完成后，按以下步骤切换到正式环境：

### 1. 配置正式域名
- 在腾讯云控制台绑定已备案的域名到服务器
- 配置DNS解析（A记录指向服务器IP）

### 2. 配置SSL证书
- 购买SSL证书或在腾讯云申请免费证书
- 配置到Nginx或使用腾讯云负载均衡

### 3. 更新小程序配置
```javascript
globalData: {
  apiBaseUrl: 'https://api.你的正式域名.com/api',  // 必须使用HTTPS
}
```

### 4. 微信公众平台配置
1. 登录[微信公众平台](https://mp.weixin.qq.com/)
2. 开发 → 开发管理 → 开发设置
3. 服务器域名 → 修改：
   - request合法域名：`https://api.你的正式域名.com`
   - uploadFile合法域名：`https://api.你的正式域名.com`
   - downloadFile合法域名：`https://api.你的正式域名.com`

### 5. 重新上传小程序
- 移除"不校验合法域名"的勾选
- 重新编译并上传代码
- 提交审核

---

## 🛠️ 开发环境vs测试环境配置

### 环境配置建议

创建配置文件来区分不同环境：

**backend/config/env.js**
```javascript
const env = process.env.NODE_ENV || 'development';

const configs = {
  development: {
    apiBaseUrl: 'http://localhost:3000/api',
    port: 3000,
  },
  test: {
    apiBaseUrl: 'http://你的服务器IP:3000/api',
    port: 3000,
  },
  production: {
    apiBaseUrl: 'https://api.你的正式域名.com/api',
    port: 3000,
  }
};

module.exports = configs[env];
```

**miniprogram/utils/config.js**（新建）
```javascript
// 环境配置
const env = 'test'; // 可选：development, test, production

const configs = {
  development: {
    apiBaseUrl: 'http://localhost:3000/api',
  },
  test: {
    apiBaseUrl: 'http://你的服务器IP:3000/api',
  },
  production: {
    apiBaseUrl: 'https://api.你的正式域名.com/api',
  }
};

export default configs[env];
```

---

## ⚠️ 重要限制说明

### 1. IP地址方案的限制（关键！）

**⚠️ 核心限制：其他微信用户无法在微信App中测试使用IP地址的小程序**

#### 详细说明：

**① 开发工具 vs 微信App的区别**
- ✅ **微信开发者工具**：可以勾选"不校验合法域名"，使用IP地址和HTTP协议
- ❌ **微信App（包括体验版）**：必须使用已在微信公众平台配置的合法域名，且必须是HTTPS协议
- ❌ **IP地址无法配置到微信公众平台的服务器域名白名单**

**② 不同版本的访问限制**
- **开发版**：只能在开发者工具中预览，无法分享给其他用户
- **体验版**：
  - ✅ 可以分享给其他微信用户
  - ❌ 但在微信App中打开时，**必须使用HTTPS域名**
  - ❌ **无法使用IP地址或HTTP协议**
- **正式版**：同样必须使用HTTPS域名

**③ 结论**
- 使用IP地址的HTTP协议方案**仅适用于开发者自己在微信开发者工具中测试**
- **无法让其他微信用户在微信App中正常使用体验版小程序**
- 其他用户打开时会出现"request合法域名校验失败"的错误

### 2. 测试环境建议

**如果要让其他用户测试**：
- ⚠️ **必须使用已备案的HTTPS域名**
- 在微信公众平台配置服务器域名
- 使用体验版分享给其他用户

**如果只是自己开发测试**：
- ✅ 可以使用IP地址 + 微信开发者工具
- ✅ 在开发者工具中勾选"不校验合法域名"
- ⚠️ 但无法分享给其他用户在微信App中测试

### 3. 数据库备份
```bash
# 定期备份数据库
mysqldump -u root -p xiaocx_db > backup_$(date +%Y%m%d).sql

# 使用crontab设置自动备份
crontab -e
# 添加：0 2 * * * mysqldump -u root -p密码 xiaocx_db > /var/backups/xiaocx_$(date +\%Y\%m\%d).sql
```

### 4. 日志管理
```bash
# PM2日志
pm2 logs xiaocx-backend --lines 100

# Nginx日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

---

## 📞 故障排查

### 问题1：小程序无法连接服务器
- ✅ 检查服务器安全组是否开放3000端口
- ✅ 检查后端服务是否正常运行：`pm2 status`
- ✅ 检查防火墙设置：`firewall-cmd --list-ports`
- ✅ 在服务器上测试：`curl http://localhost:3000/health`

### 问题2：域名无法访问
- ✅ 检查DNS解析是否正确
- ✅ 检查Nginx配置：`nginx -t`
- ✅ 检查SSL证书是否过期
- ✅ 查看Nginx错误日志

### 问题3：数据库连接失败
- ✅ 检查MySQL服务：`systemctl status mysqld`
- ✅ 检查数据库用户权限
- ✅ 检查.env文件配置是否正确
- ✅ 测试连接：`mysql -u root -p -h localhost`

---

## 🎯 推荐实施步骤

1. **立即执行**（今天）
   - [ ] 购买腾讯云服务器（如果还没有）
   - [ ] 配置安全组，开放必要端口
   - [ ] 在服务器上部署后端代码

2. **配置测试环境**（1-2天）
   - [ ] 配置数据库和导入数据
   - [ ] 使用PM2启动后端服务
   - [ ] 修改小程序API地址为服务器IP
   - [ ] 在微信开发者工具中测试

3. **发布体验版**（2-3天）
   - [ ] 上传小程序代码
   - [ ] 提交审核（体验版）
   - [ ] 分享体验版给团队成员测试

4. **等待备案完成**（15-20个工作日）
   - [ ] 定期检查备案状态
   - [ ] 准备正式域名和SSL证书

5. **切换到正式环境**（备案完成后）
   - [ ] 配置正式域名和HTTPS
   - [ ] 更新小程序配置
   - [ ] 在微信公众平台配置服务器域名
   - [ ] 发布正式版

---

## 💡 总结与建议

### 重要结论

**❌ 使用IP地址无法让其他微信用户在微信App中测试体验版小程序**

### 两种场景的解决方案

#### 场景一：仅自己开发测试
- ✅ 使用服务器IP地址（如：`http://123.456.789.012:3000/api`）
- ✅ 在微信开发者工具中勾选"不校验合法域名"
- ✅ 可以在开发者工具中正常开发调试
- ⚠️ **无法分享给其他用户**，因为其他用户在微信App中打开会报域名校验错误

#### 场景二：需要让其他微信用户测试（推荐）
- ✅ **必须使用已备案的HTTPS域名**
- ✅ 配置SSL证书
- ✅ 在微信公众平台配置服务器域名
- ✅ 上传体验版，可以分享给其他用户
- ⚠️ **需要等待备案完成**，或使用其他已备案的域名

### 推荐方案

1. **开发阶段**（现在）：
   - 使用IP地址在开发者工具中继续开发
   - 等待备案完成

2. **测试阶段**（备案完成后）：
   - 配置已备案的HTTPS域名
   - 在微信公众平台配置服务器域名
   - 上传体验版供其他用户测试

3. **正式发布**：
   - 使用正式域名
   - 提交审核并发布正式版

### 如果急需让其他用户测试

如果您急需让其他用户测试，可以考虑：
1. **使用已备案的其他域名**（如果有）
2. **申请临时测试域名**（如果腾讯云提供此服务）
3. **等待备案完成**（15-20个工作日）

**备案完成后才能让其他微信用户正常使用小程序，这是微信小程序平台的硬性要求。**

