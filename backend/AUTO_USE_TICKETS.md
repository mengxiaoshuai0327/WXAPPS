# 自动核销课券功能说明

## 功能概述

当会员预订的课程开课后，系统会自动将使用的课券从"已预订"状态切换为"已使用"状态。

## 核销规则

根据课程时间段，系统会在以下时间点自动核销课券：

1. **上午课程（9:00-12:00）**：在 **9:00** 自动核销
2. **下午课程（14:00-17:00）**：在 **14:00** 自动核销
3. **全天课程（9:00-17:00）**：在 **17:00** 自动核销

## 实现方式

### 1. 自动定时任务

应用启动后，系统会每 **5分钟** 自动执行一次核销检查任务。

- 定时任务表达式：`*/5 * * * *`（每5分钟执行一次）
- 执行位置：`backend/app.js`
- 任务函数：`backend/utils/scheduler.js` 中的 `autoUseTickets()`

### 2. 手动触发接口

如果需要手动触发核销任务，可以调用以下接口：

```bash
POST http://localhost:3000/api/cron/auto-use-tickets
```

**响应示例：**
```json
{
  "success": true,
  "message": "自动核销完成，处理了 3 个预订",
  "processed": 3,
  "total": 5
}
```

## 处理流程

1. **查找待核销预订**
   - 查找当天（`schedule_date`）的课程预订
   - 预订状态为 `booked`
   - 课券状态为 `booked`
   - 课券ID不为空

2. **判断核销时间**
   - 根据课程时间段（`time_slot`）和当前时间判断是否应该核销
   - 上午课程：当前时间 >= 09:00
   - 下午课程：当前时间 >= 14:00
   - 全天课程：当前时间 >= 17:00

3. **执行核销操作**
   - 更新课券状态：`tickets.status` 从 `booked` 改为 `used`
   - 设置使用时间：`tickets.used_at` 设置为当前时间
   - 更新预订状态：`course_bookings.status` 从 `booked` 改为 `completed`
   - 更新课程状态：如果课程状态为 `scheduled`，更新为 `completed`

## 日志输出

系统会在控制台输出详细的执行日志：

```
[自动核销] 开始检查 2025-12-08 09:05 的课程
[自动核销] 找到 3 个待核销的预订
[自动核销] 上午课程 123 在 09:05 核销
[自动核销] 成功核销预订 45，课券 67
[自动核销] 完成，共处理 3 个预订
```

## 注意事项

1. **时间精度**：定时任务每5分钟执行一次，因此核销时间可能有最多5分钟的延迟
2. **事务处理**：所有核销操作都在数据库事务中执行，确保数据一致性
3. **重复执行**：系统会检查课券状态，避免重复核销
4. **错误处理**：如果核销过程中出现错误，会回滚事务并记录错误日志

## 测试方法

### 1. 手动测试

```bash
# 使用 curl 手动触发
curl -X POST http://localhost:3000/api/cron/auto-use-tickets
```

### 2. 查看日志

查看后端服务控制台输出，确认核销任务是否正常执行。

### 3. 数据库验证

```sql
-- 查看已核销的课券
SELECT * FROM tickets WHERE status = 'used' AND used_at >= CURDATE();

-- 查看已完成的预订
SELECT * FROM course_bookings WHERE status = 'completed' AND DATE(booked_at) = CURDATE();
```

## 配置说明

如果需要修改定时任务的执行频率，可以编辑 `backend/app.js`：

```javascript
// 修改为每10分钟执行一次
cron.schedule('*/10 * * * *', async () => {
  // ...
});

// 修改为每小时执行一次
cron.schedule('0 * * * *', async () => {
  // ...
});
```

## 故障排查

### 问题：定时任务没有执行

1. 检查应用是否正常启动
2. 查看控制台是否有"定时任务已启动"的日志
3. 检查 `NODE_ENV` 环境变量（测试环境会禁用定时任务）

### 问题：课券没有自动核销

1. 确认课程日期是今天
2. 确认当前时间已经超过核销时间点
3. 检查课券和预订状态是否正确
4. 查看控制台日志，确认是否有错误信息

### 问题：重复核销

系统已经做了防护，只会核销状态为 `booked` 的课券，不会重复核销。

