# 动态案例功能说明

## 功能概述

实现了课程评价问卷中的动态案例功能，允许授课老师在课程设计时输入案例名称，案例数量不固定。学员在填写问卷时，会根据课程配置动态显示案例评分题。

## 功能特点

1. **授课老师输入案例**：在课程创建/编辑时，可以添加多个案例，每个案例有独立的名称
2. **案例数量不固定**：支持任意数量的案例（至少1个）
3. **动态问卷生成**：根据课程的案例配置，动态生成问卷中的案例评分题
4. **评价数据收集**：收集每个案例的评分（1-5分）
5. **评价明细显示**：在评价明细列表中显示案例的真实名称和评分

## 数据库设计

### 课程表（courses）

使用现有的 `questionnaire_config` 字段（JSON类型）存储案例信息：

```json
{
  "cases": [
    { "id": "case1", "name": "案例1：财务报表分析" },
    { "id": "case2", "name": "案例2：成本控制策略" },
    { "id": "case3", "name": "案例3：投资决策分析" }
  ]
}
```

## 前端功能

### 1. 课程创建/编辑表单

**位置**：`admin/src/views/courses/List.vue`

**功能**：
- 添加"课程案例"输入区域
- 支持动态添加/删除案例
- 每个案例输入框可以输入案例名称
- 至少保留一个案例输入框

**界面**：
```
课程案例
[案例1名称输入框] [删除按钮]
[案例2名称输入框] [删除按钮]
...
[+ 添加案例按钮]
提示：案例将用于课程评价问卷的案例评分题，学员需要对每个案例进行1-5分评分
```

### 2. 问卷模板动态加载

**位置**：`miniprogram/pages/evaluation/submit/submit.js`

**功能**：
- 根据课程ID动态加载问卷模板
- 如果课程有案例配置，自动更新q6（案例评分题）的选项
- 问卷中的案例名称显示为授课老师输入的名称

### 3. 评价明细列表

**位置**：`admin/src/views/evaluations/List.vue`

**功能**：
- 显示每个案例的真实名称（而不是case1, case2等）
- 显示每个案例的评分（星级+分数）
- 在详情对话框中，也显示案例的真实名称

## 后端API

### 1. 创建/更新课程

**接口**：
- `POST /api/courses/admin/create`
- `PUT /api/courses/admin/:id`

**请求体**：
```json
{
  "theme_id": 1,
  "instructor_id": 1,
  "course_code": "COMM001",
  "title": "课程标题",
  "questionnaire_config": {
    "cases": [
      { "id": "case1", "name": "案例1名称" },
      { "id": "case2", "name": "案例2名称" }
    ]
  }
}
```

### 2. 获取课程列表

**接口**：`GET /api/courses/admin/list`

**响应**：
- 自动解析 `questionnaire_config` 字段
- 返回课程信息，包含案例配置

### 3. 获取问卷模板（动态）

**接口**：`GET /api/evaluations/questionnaire-template?course_id=1`

**功能**：
- 如果提供了 `course_id`，根据课程的案例配置动态生成问卷
- 更新q6（案例评分题）的 `ratingItems`，使用课程中的案例名称

**响应示例**：
```json
{
  "success": true,
  "data": {
    "questions": [
      {
        "id": "q6",
        "type": "rating",
        "text": "您认为授课中所用案例是否有效帮助了课程的学习？（1最无效，5最有效）",
        "ratingItems": [
          { "id": "case1", "label": "案例1：财务报表分析" },
          { "id": "case2", "label": "案例2：成本控制策略" },
          { "id": "case3", "label": "案例3：投资决策分析" }
        ]
      }
    ]
  }
}
```

### 4. 获取评价列表

**接口**：`GET /api/admin/evaluations`

**功能**：
- 返回评价数据时，同时返回课程的 `questionnaire_config`
- 前端可以根据课程配置显示案例的真实名称

### 5. 获取评价详情

**接口**：`GET /api/admin/evaluations/:id`

**功能**：
- 返回评价详情时，包含课程的案例配置
- 前端可以正确显示案例名称

## 数据流程

### 1. 课程设计阶段

```
授课老师 → 创建/编辑课程
    ↓
输入案例名称（可添加多个）
    ↓
保存到 questionnaire_config.cases
    ↓
存储到 courses.questionnaire_config (JSON)
```

### 2. 问卷填写阶段

```
学员 → 点击填写评价
    ↓
前端请求问卷模板（带course_id）
    ↓
后端根据课程配置动态生成问卷
    ↓
问卷中显示课程的真实案例名称
    ↓
学员对每个案例进行1-5分评分
    ↓
提交评价数据
```

### 3. 评价数据存储

```
评价答案存储在 evaluations.answers (JSON)
    ↓
q6字段格式：
{
  "q6": {
    "case1": 5,
    "case2": 4,
    "case3": 5
  }
}
```

### 4. 评价明细显示

```
管理员查看评价明细
    ↓
后端返回评价数据 + 课程配置
    ↓
前端根据课程配置显示案例真实名称
    ↓
显示：案例1：财务报表分析 - 5分
      案例2：成本控制策略 - 4分
      案例3：投资决策分析 - 5分
```

## 代码修改清单

### 前端（Admin）

1. **`admin/src/views/courses/List.vue`**
   - 添加案例输入区域
   - 实现添加/删除案例功能
   - 保存时将案例转换为 `questionnaire_config`
   - 编辑时从 `questionnaire_config` 解析案例

2. **`admin/src/views/evaluations/List.vue`**
   - 更新 `getCaseLabel` 函数，支持动态案例名称
   - 在列表和详情中显示案例真实名称

### 前端（小程序）

1. **`miniprogram/pages/evaluation/submit/submit.js`**
   - 加载问卷模板时传递 `course_id`
   - 支持动态案例数量的评分

### 后端

1. **`backend/routes/admin/courses.js`**
   - 创建/更新课程时保存 `questionnaire_config`
   - 获取课程列表时解析 `questionnaire_config`

2. **`backend/routes/evaluations.js`**
   - 获取问卷模板时，根据 `course_id` 动态加载案例

3. **`backend/routes/admin/evaluations.js`**
   - 获取评价列表时，同时返回课程的 `questionnaire_config`
   - 获取评价详情时，包含课程配置

## 使用说明

### 授课老师操作

1. 登录管理后台
2. 进入【课程管理】→【课程列表】
3. 创建新课程或编辑现有课程
4. 在"课程案例"区域：
   - 输入第一个案例名称
   - 点击"+ 添加案例"添加更多案例
   - 可以删除不需要的案例（至少保留1个）
5. 保存课程

### 学员操作

1. 学员在填写评价时，问卷会自动显示该课程的真实案例名称
2. 对每个案例进行1-5分评分
3. 提交评价

### 管理员查看

1. 进入【评价管理】→【评价明细】
2. 在列表中可以看到每个案例的真实名称和评分
3. 点击"详情"查看完整的评价信息

## 注意事项

1. **案例数量**：至少需要1个案例，否则问卷中的案例评分题可能无法正常显示
2. **案例ID**：系统自动生成案例ID（case1, case2...），建议不要手动修改
3. **向后兼容**：如果课程没有配置案例，系统会使用默认的6个案例（case1-case6）
4. **数据格式**：案例配置以JSON格式存储在 `questionnaire_config` 字段中

## 示例数据

### 课程配置示例

```json
{
  "cases": [
    { "id": "case1", "name": "案例1：财务报表分析" },
    { "id": "case2", "name": "案例2：成本控制策略" },
    { "id": "case3", "name": "案例3：投资决策分析" },
    { "id": "case4", "name": "案例4：风险管理实践" }
  ]
}
```

### 评价答案示例

```json
{
  "q6": {
    "case1": 5,
    "case2": 4,
    "case3": 5,
    "case4": 4
  }
}
```

### 显示效果

在评价明细列表中显示：
- 案例1：财务报表分析 - ⭐⭐⭐⭐⭐ 5分
- 案例2：成本控制策略 - ⭐⭐⭐⭐ 4分
- 案例3：投资决策分析 - ⭐⭐⭐⭐⭐ 5分
- 案例4：风险管理实践 - ⭐⭐⭐⭐ 4分

