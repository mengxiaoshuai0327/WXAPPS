# 课程评价系统完整说明

## 系统流程

### 1. 授课老师触发问卷
**位置**：管理后台 → 课程管理 → 排课列表

**操作步骤**：
1. 授课老师登录管理后台
2. 进入【课程管理】→【排课列表】
3. 找到已完成的课程（状态为"已完成"）
4. 点击"触发问卷"按钮
5. 系统执行以下操作：
   - 更新 `course_schedules.questionnaire_triggered = TRUE`
   - 为所有已报名学员发送系统消息提醒
   - 返回成功消息

**API接口**：
```
POST /api/courses/admin/schedules/:id/trigger-questionnaire
请求体: { "instructor_id": 1 }
```

### 2. 系统推送问卷给用户
**自动执行**：
- 系统消息插入到 `system_messages` 表
- 消息类型：`evaluation_reminder`
- 消息标题：`课程评价提醒`
- 消息内容：`您参加的课程"XXX"已结束，请填写课程评价问卷。`

### 3. 用户填写问卷
**位置**：小程序首页 → 课程评价模块

**操作步骤**：
1. 用户在小程序首页看到【课程评价】提醒
2. 点击"去评价"进入评价列表页面
3. 选择待评价课程，点击"开始评价"
4. 填写完整问卷（包含11个问题）
5. 提交评价

**问卷问题**：
1. **q1**: 培训价值评价（单选题）
2. **q2**: CFO水平评价（单选题）
3. **q3**: 认知突破评价（单选题）
4. **q4**: 应用帮助评价（单选题）
5. **q5**: 教练启发式授课建议（单选题）
6. **q6**: 案例评分（矩阵评分题，6个案例，1-5分）
7. **q7**: 反馈和建议（文本题）
8. **q8**: 未来课程报名意愿（矩阵单选题，3行3列）
9. **q9**: 推荐意愿（单选题）
10. **q10**: 姓名（文本题）
11. **q11**: 手机号码（文本题）

### 4. 数据采集到评价明细表
**数据存储**：
- 所有问卷答案存储在 `evaluations.answers` 字段（JSON格式）
- 反馈意见存储在 `evaluations.feedback` 字段
- 评价状态：`submitted`
- 提交时间：`submitted_at`

**数据格式示例**：
```json
{
  "q1": "A",
  "q2": "B",
  "q3": "A",
  "q4": "A",
  "q5": "A",
  "q6": {
    "case1": 5,
    "case2": 4,
    "case3": 5,
    "case4": 4,
    "case5": 5,
    "case6": 4
  },
  "q7": "课程内容很实用，希望能有更多案例...",
  "q8": {
    "row1": "col1",
    "row2": "col2",
    "row3": "col3"
  },
  "q9": "A",
  "q10": "张三",
  "q11": "13800138000"
}
```

## 评价明细列表设计

### 列表列说明
按照问卷格式设计，包含以下列：

1. **ID** - 评价记录ID
2. **姓名/手机号** - 优先显示问卷中的姓名和手机号（q10, q11）
3. **课程信息** - 课程名称、上课日期、时间段
4. **1) 培训价值** - q1的答案，带颜色标签
5. **2) CFO水平** - q2的答案，带颜色标签
6. **3) 认知突破** - q3的答案，带颜色标签
7. **4) 应用帮助** - q4的答案，带颜色标签
8. **5) 教练启发式授课** - q5的答案
9. **6) 案例评分** - q6的所有案例评分，显示星级和分数
10. **7) 反馈建议** - q7的文本反馈
11. **8) 未来课程报名** - q8的矩阵答案
12. **9) 推荐意愿** - q9的答案
13. **评价时间** - 提交时间
14. **操作** - 查看详情、删除

### 详情对话框
点击"详情"按钮，显示完整的问卷答案，按照问卷结构展示：
- 每个问题独立显示
- 带边框和颜色区分
- 案例评分以列表形式展示
- 矩阵题以表格形式展示
- 反馈建议支持多行文本

## 问卷模板配置

问卷模板定义在 `backend/config/questionnaire-template.js`，包含：

- **单选题** (q1-q5, q9): 使用 `radio-group`
- **矩阵评分题** (q6): 6个案例，每个1-5分
- **矩阵单选题** (q8): 3行3列矩阵
- **文本题** (q7, q10, q11): 使用 `textarea` 或 `input`

## 数据验证

### 前端验证
- 必填项检查
- 矩阵题所有行必须选择
- 评分题所有项必须评分

### 后端验证
- 检查课程是否已触发问卷
- 检查用户是否已评价过
- 验证数据格式

## API接口

### 1. 触发问卷
```
POST /api/courses/admin/schedules/:id/trigger-questionnaire
```

### 2. 获取问卷模板
```
GET /api/evaluations/questionnaire-template
```

### 3. 获取待评价课程
```
GET /api/evaluations/pending?user_id=1
```

### 4. 提交评价
```
POST /api/evaluations/submit
请求体: {
  user_id: 1,
  schedule_id: 1,
  course_id: 1,
  questionnaire_data: { ... },
  feedback: "..."
}
```

### 5. 获取评价明细列表
```
GET /api/admin/evaluations?page=1&pageSize=20
```

### 6. 获取课程评价跟进列表
```
GET /api/admin/evaluations/follow-up?page=1&pageSize=20
```

## 前端页面

### 小程序端
1. **首页** (`miniprogram/pages/index/`)
   - 显示待评价课程提醒
   - 点击跳转到评价列表

2. **评价列表** (`miniprogram/pages/evaluation/evaluation.js`)
   - 显示待评价课程列表
   - 点击进入填写问卷

3. **评价提交** (`miniprogram/pages/evaluation/submit/`)
   - 动态加载问卷模板
   - 支持所有题型
   - 提交完整问卷数据

### 管理后台
1. **排课列表** (`admin/src/views/courses/Schedules.vue`)
   - 显示问卷触发状态
   - 提供"触发问卷"按钮

2. **评价管理** (`admin/src/views/evaluations/List.vue`)
   - Tab 1: 课程评价跟进列表
   - Tab 2: 评价明细列表（按问卷格式设计）

## 数据流程总结

```
授课老师 → 点击"触发问卷" 
    ↓
系统更新 questionnaire_triggered = TRUE
    ↓
系统发送消息给所有已报名学员
    ↓
学员在首页看到【课程评价】提醒
    ↓
学员点击进入评价页面
    ↓
学员填写完整问卷
    ↓
提交评价数据
    ↓
数据保存到 evaluations 表
    ↓
管理员在【评价明细】列表中查看
```

## 注意事项

1. **权限控制**：只有该课程的授课人才能触发问卷
2. **防重复触发**：每个课程只能触发一次问卷
3. **状态检查**：只有状态为"已完成"的课程才能触发问卷
4. **必填验证**：前端和后端都会验证必填项
5. **数据格式**：问卷答案以JSON格式存储，支持复杂数据结构（对象、数组）

