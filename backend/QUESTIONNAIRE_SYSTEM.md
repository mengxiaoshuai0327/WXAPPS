# 课程评价问卷系统说明

## 功能概述

实现了完整的课程评价问卷系统，支持教师触发问卷、学员填写问卷、后台查看评价结果。

## 工作流程

1. **教师触发问卷**：课程结束前，授课教师在后台排课列表中点击"触发问卷"按钮
2. **系统通知学员**：系统自动为所有已报名该课程的学员发送系统消息提醒
3. **学员填写问卷**：学员在首页【课程评价】模块看到提醒，点击进入填写问卷
4. **数据存储**：问卷数据存储在 `evaluations` 表中
5. **后台查看**：管理员在后台【评价管理】列表中查看所有评价结果

## 数据库变更

### 新增字段

在 `course_schedules` 表中添加了 `questionnaire_triggered` 字段：

```sql
ALTER TABLE course_schedules 
ADD COLUMN questionnaire_triggered BOOLEAN DEFAULT FALSE COMMENT '问卷是否已触发';
```

### 运行迁移脚本

```bash
cd backend
node scripts/add-questionnaire-trigger-field.js
```

## 问卷模板

问卷模板定义在 `backend/config/questionnaire-template.js`，包含11个问题：

1. **q1**: 是否参加过类似培训及本次培训价值（单选题）
2. **q2**: 主讲老师水平是否达到预期（单选题）
3. **q3**: 认知突破，新的框架和方法论（单选题）
4. **q4**: 如何将认知突破应用于解决实际问题（单选题）
5. **q5**: 是否希望继续采用互动式教学方式（单选题）
6. **q6**: 教学方法有效性评分（1-5分，6个评分项）
7. **q7**: 意见和建议（文本题）
8. **q8**: 未来是否愿意报名更多课程（多选题）
9. **q9**: 是否愿意推荐课程（单选题）
10. **q10**: 姓名（文本题，可选）
11. **q11**: 手机号码（文本题，可选）

## API接口

### 1. 教师触发问卷

**接口**: `POST /api/courses/admin/schedules/:id/trigger-questionnaire`

**请求体**:
```json
{
  "instructor_id": 1
}
```

**响应**:
```json
{
  "success": true,
  "message": "问卷已触发，已通知 5 位学员",
  "notified_count": 5
}
```

### 2. 获取问卷模板

**接口**: `GET /api/evaluations/questionnaire-template`

**响应**:
```json
{
  "success": true,
  "data": {
    "questions": [...]
  }
}
```

### 3. 获取待评价课程（已更新）

**接口**: `GET /api/evaluations/pending?user_id=1`

**说明**: 现在只返回已触发问卷的课程

### 4. 提交评价（已更新）

**接口**: `POST /api/evaluations/submit`

**请求体**:
```json
{
  "user_id": 1,
  "schedule_id": 1,
  "course_id": 1,
  "questionnaire_data": {
    "q1": "A",
    "q2": "B",
    "q6": {
      "r1": 5,
      "r2": 4,
      ...
    },
    ...
  },
  "feedback": "意见和建议..."
}
```

### 5. 后台获取评价列表

**接口**: `GET /api/admin/evaluations`

**查询参数**:
- `page`: 页码
- `pageSize`: 每页数量
- `course_id`: 课程ID（可选）
- `schedule_id`: 排课ID（可选）

## 前端功能

### 后台管理

1. **排课列表** (`admin/src/views/courses/Schedules.vue`)
   - 显示问卷触发状态
   - 提供"触发问卷"按钮（仅课程状态为 completed 且未触发时可用）
   - 点击后确认并触发问卷

2. **评价管理** (`admin/src/views/evaluations/List.vue`)
   - 显示所有评价记录
   - 显示完整的问卷答案
   - 支持查看详情
   - 支持删除评价

### 小程序端

1. **评价提交页面** (`miniprogram/pages/evaluation/submit/`)
   - 动态加载问卷模板
   - 支持单选题、多选题、评分题、文本题
   - 验证必填项
   - 提交完整问卷数据

2. **首页评价提醒** (`miniprogram/pages/index/`)
   - 自动显示待评价课程数量
   - 点击跳转到评价页面

## 使用说明

### 教师触发问卷

1. 登录管理后台
2. 进入【课程管理】->【排课列表】
3. 找到已完成的课程（状态为"已完成"）
4. 点击"触发问卷"按钮
5. 确认后，系统会：
   - 标记该课程问卷已触发
   - 为所有已报名学员发送系统消息提醒

### 学员填写问卷

1. 学员在首页看到【课程评价】模块的提醒
2. 点击进入评价页面
3. 填写完整的问卷
4. 提交后数据保存到后台

### 管理员查看评价

1. 登录管理后台
2. 进入【评价管理】
3. 查看所有评价记录
4. 点击"详情"查看完整的问卷答案

## 注意事项

1. **权限控制**：只有该课程的授课人才能触发问卷
2. **防重复触发**：每个课程只能触发一次问卷
3. **状态检查**：只有状态为"已完成"的课程才能触发问卷
4. **必填验证**：前端和后端都会验证必填项
5. **数据格式**：问卷答案以JSON格式存储在 `evaluations.answers` 字段中

## 数据格式示例

### 评价数据存储格式

```json
{
  "q1": "A",
  "q2": "B",
  "q3": "A",
  "q4": "A",
  "q5": "A",
  "q6": {
    "r1": 5,
    "r2": 4,
    "r3": 5,
    "r4": 4,
    "r5": 5,
    "r6": 4
  },
  "q7": "课程内容很实用，希望能有更多案例...",
  "q8": ["A", "B"],
  "q9": "A",
  "q10": "张三",
  "q11": "13800138000"
}
```

## 后续优化建议

1. 支持自定义问卷模板（不同课程可以使用不同的问卷）
2. 添加问卷统计分析功能
3. 支持导出评价数据为Excel
4. 添加评价数据可视化图表

